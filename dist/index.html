<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#818CF8" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="LC Recall" />
  <title>Èù¢ËØï Killer üî•</title>
  <link rel="manifest" href="./manifest.json" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß†</text></svg>" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #09090B;
      --surface: #18181B;
      --surface2: #1F1F23;
      --surface3: #27272A;
      --border: #2E2E32;
      --border2: #3F3F46;
      --text: #FAFAFA;
      --text2: #D4D4D8;
      --muted: #71717A;
      --accent: #818CF8;
      --accent2: #6366F1;
      --accent-glow: rgba(129,140,248,.15);
      --green: #4ADE80;
      --green2: #22C55E;
      --green-soft: rgba(74,222,128,.1);
      --red: #F87171;
      --red-soft: rgba(248,113,113,.1);
      --orange: #FB923C;
      --orange-soft: rgba(251,146,60,.1);
      --blue: #60A5FA;
      --yellow: #FBBF24;
      --mono: 'JetBrains Mono', monospace;
      --sans: 'Inter', system-ui, -apple-system, sans-serif;
      --ease: cubic-bezier(.4,0,.2,1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }

    body {
      font-family: var(--sans);
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
    }

    /* ---- Layout ---- */
    .app { max-width: 720px; margin: 0 auto; padding: 0 20px; }

    /* ---- Header ---- */
    .header {
      padding: 48px 0 40px;
      text-align: center;
      position: relative;
    }
    .header::after {
      content: '';
      position: absolute;
      bottom: 0; left: 50%;
      transform: translateX(-50%);
      width: 120px; height: 1px;
      background: linear-gradient(90deg, transparent, var(--border2), transparent);
    }
    .logo {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 12px;
    }
    .hero {
      font-size: 32px;
      font-weight: 900;
      letter-spacing: -.5px;
      line-height: 1.2;
    }
    .hero-gradient {
      background: linear-gradient(135deg, #818CF8 0%, #4ADE80 50%, #60A5FA 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-size: 200% auto;
      animation: shimmer 3s ease infinite;
    }
    @keyframes shimmer {
      0%,100% { background-position: 0% center; }
      50% { background-position: 100% center; }
    }
    .subtitle {
      color: var(--muted);
      font-size: 14px;
      margin-top: 8px;
      font-weight: 400;
    }

    /* ---- Stats Row ---- */
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1px;
      background: var(--border);
      border-radius: 16px;
      overflow: hidden;
      margin: 32px 0;
    }
    .stat {
      background: var(--surface);
      padding: 20px 16px;
      text-align: center;
      transition: background .2s var(--ease);
    }
    .stat:hover { background: var(--surface2); }
    .stat-num {
      font-size: 32px;
      font-weight: 900;
      font-family: var(--mono);
      line-height: 1;
    }
    .stat-num.purple { color: var(--accent); }
    .stat-num.green { color: var(--green); }
    .stat-num.orange { color: var(--orange); }
    .stat-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-top: 6px;
      font-weight: 600;
    }

    /* ---- Buttons ---- */
    .btn-row {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 28px 0;
      flex-wrap: wrap;
    }
    .btn {
      font-family: var(--sans);
      font-size: 14px;
      font-weight: 600;
      padding: 12px 24px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
      transition: all .2s var(--ease);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
    }
    .btn:hover { background: var(--surface2); border-color: var(--border2); transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn-primary {
      background: var(--accent2);
      border-color: var(--accent2);
      color: white;
      box-shadow: 0 0 20px var(--accent-glow);
    }
    .btn-primary:hover { background: #5558E6; box-shadow: 0 0 30px var(--accent-glow); }
    .btn-ghost {
      background: transparent;
      border-color: var(--border);
    }
    .btn-ghost:hover { background: var(--surface); }
    .btn-sm { padding: 8px 16px; font-size: 13px; border-radius: 8px; }
    .btn-icon { width: 40px; height: 40px; padding: 0; justify-content: center; border-radius: 10px; }

    /* ---- Problem Grid ---- */
    .section-title {
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      margin: 32px 0 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    #problemSection { display: none; }
    #problemSection.open { display: block; animation: fadeIn .3s var(--ease); }

    .pgrid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
    }
    .pcard {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      cursor: pointer;
      transition: all .2s var(--ease);
      position: relative;
      overflow: hidden;
    }
    .pcard::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 14px;
      padding: 1px;
      background: linear-gradient(135deg, transparent 40%, var(--accent) 100%);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0;
      transition: opacity .3s;
    }
    .pcard:hover { transform: translateY(-3px); box-shadow: 0 8px 30px rgba(0,0,0,.3); }
    .pcard:hover::before { opacity: 1; }
    .pcard-num {
      font-size: 11px;
      font-family: var(--mono);
      color: var(--muted);
      font-weight: 500;
    }
    .pcard-title {
      font-size: 14px;
      font-weight: 700;
      margin: 6px 0 10px;
      line-height: 1.3;
    }
    .pcard-tags { display: flex; gap: 6px; flex-wrap: wrap; }
    .pcard-status {
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 6px;
    }
    .pcard-status.due { background: var(--orange-soft); color: var(--orange); }
    .pcard-status.mastered { background: var(--green-soft); color: var(--green); }

    .tag {
      font-size: 10px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 6px;
      letter-spacing: .5px;
      text-transform: uppercase;
    }
    .tag-easy { background: var(--green-soft); color: var(--green); }
    .tag-medium { background: var(--orange-soft); color: var(--orange); }
    .tag-hard { background: var(--red-soft); color: var(--red); }
    .tag-cat {
      background: rgba(255,255,255,.05);
      color: var(--muted);
    }

    /* ---- Quiz Area ---- */
    #quizArea { display: none; }
    #quizArea.open { display: block; animation: fadeIn .4s var(--ease); }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .quiz-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 24px;
    }
    .quiz-info { }
    .quiz-name {
      font-size: 22px;
      font-weight: 800;
      letter-spacing: -.3px;
    }
    .quiz-meta {
      display: flex;
      gap: 8px;
      margin-top: 6px;
      align-items: center;
    }

    /* ---- Stepper ---- */
    .stepper {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin: 0 0 28px;
    }
    .step {
      width: 40px;
      height: 5px;
      border-radius: 99px;
      background: var(--surface3);
      transition: all .3s var(--ease);
      cursor: pointer;
    }
    .step.active { background: var(--accent); width: 56px; }
    .step.done { background: var(--green2); }

    /* ---- Exercise Card ---- */
    .ex-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 18px;
      overflow: hidden;
      margin-bottom: 24px;
      animation: slideIn .4s var(--ease);
    }
    .ex-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 24px;
      background: var(--surface2);
      border-bottom: 1px solid var(--border);
    }
    .ex-type {
      font-size: 14px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .ex-type-icon {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .ex-type-icon.recall { background: rgba(129,140,248,.15); }
    .ex-type-icon.fill { background: rgba(96,165,250,.15); }
    .ex-type-icon.choice { background: rgba(251,146,60,.15); }
    .ex-type-icon.bug { background: rgba(248,113,113,.15); }
    .ex-type-icon.transfer { background: rgba(74,222,128,.15); }
    .ex-timer {
      font-size: 13px;
      font-family: var(--mono);
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .timer-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--green);
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%,100% { opacity: 1; }
      50% { opacity: .3; }
    }
    .timer-dot.stopped { animation: none; background: var(--muted); }

    .ex-body { padding: 24px; }
    .ex-question {
      font-size: 15px;
      line-height: 1.7;
      color: var(--text2);
      margin-bottom: 20px;
    }

    /* ---- Code Blocks ---- */
    pre {
      background: #0D0D0F;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      overflow-x: auto;
      font-family: var(--mono);
      font-size: 13px;
      line-height: 1.7;
      margin: 16px 0;
      position: relative;
    }
    pre::before {
      content: 'python';
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }
    code { font-family: var(--mono); font-size: 13px; }

    /* Syntax highlighting */
    .kw { color: #C792EA; }
    .fn { color: #82AAFF; }
    .str { color: #C3E88D; }
    .num { color: #F78C6C; }
    .cmt { color: #546E7A; font-style: italic; }
    .op { color: #89DDFF; }
    .var { color: #EEFFFF; }
    .blank { 
      background: rgba(129,140,248,.15);
      color: var(--accent);
      padding: 2px 16px;
      border-radius: 4px;
      border-bottom: 2px dashed var(--accent);
      font-weight: 600;
    }
    .bug-mark {
      background: var(--red-soft);
      border-radius: 4px;
      display: inline;
    }

    .icode {
      background: var(--surface3);
      padding: 2px 7px;
      border-radius: 5px;
      font-family: var(--mono);
      font-size: 12px;
    }

    /* ---- Textarea (Recall/Fill input) ---- */
    .input-area {
      width: 100%;
      min-height: 120px;
      background: #0D0D0F;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 20px;
      font-family: var(--mono);
      font-size: 13px;
      line-height: 1.7;
      color: var(--text);
      resize: vertical;
      outline: none;
      transition: border-color .2s var(--ease);
    }
    .input-area:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    .input-area::placeholder {
      color: var(--muted);
      opacity: .6;
    }
    .input-area.code-input {
      min-height: 200px;
      tab-size: 4;
      white-space: pre;
    }

    /* ---- Submit / Check button ---- */
    .submit-btn {
      width: 100%;
      padding: 14px;
      margin-top: 16px;
      background: var(--accent2);
      border: 1px solid var(--accent2);
      border-radius: 12px;
      color: white;
      font-weight: 700;
      font-size: 14px;
      font-family: var(--sans);
      cursor: pointer;
      transition: all .2s var(--ease);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .submit-btn:hover { background: #5558E6; box-shadow: 0 0 20px var(--accent-glow); }
    .submit-btn:disabled { opacity: .4; cursor: not-allowed; }

    /* ---- Comparison View (Recall) ---- */
    .compare-view {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 16px;
      animation: fadeIn .3s var(--ease);
    }
    .compare-col {
      background: #0D0D0F;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      overflow-x: auto;
    }
    .compare-label {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .compare-label.user { color: var(--blue); }
    .compare-label.ref { color: var(--green); }
    .compare-content {
      font-size: 14px;
      line-height: 1.7;
      color: var(--text2);
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* ---- Diff View (Fill) ---- */
    .diff-view {
      margin-top: 16px;
      animation: fadeIn .3s var(--ease);
    }
    .diff-line {
      font-family: var(--mono);
      font-size: 13px;
      line-height: 1.7;
      padding: 2px 12px;
      white-space: pre;
      border-radius: 4px;
      margin: 1px 0;
    }
    .diff-line.same { color: var(--text2); }
    .diff-line.added { background: rgba(74,222,128,.1); color: var(--green); }
    .diff-line.removed { background: rgba(248,113,113,.1); color: var(--red); }
    .diff-line.changed { background: rgba(251,146,60,.08); color: var(--orange); }
    .diff-container {
      background: #0D0D0F;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      overflow-x: auto;
    }
    .diff-label {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .diff-legend {
      display: flex;
      gap: 16px;
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
    }
    .diff-legend span { display: flex; align-items: center; gap: 4px; }
    .diff-dot { width: 8px; height: 8px; border-radius: 2px; display: inline-block; }
    .diff-dot.g { background: var(--green); }
    .diff-dot.r { background: var(--red); }

    /* ---- Self-Rating Buttons ---- */
    .self-rating {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      animation: fadeIn .3s var(--ease);
    }
    .rate-btn {
      flex: 1;
      padding: 14px 8px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-family: var(--sans);
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all .2s var(--ease);
      text-align: center;
      line-height: 1.4;
    }
    .rate-btn:hover { transform: translateY(-2px); }
    .rate-btn.good {
      border-color: rgba(74,222,128,.3);
    }
    .rate-btn.good:hover {
      background: var(--green-soft);
      border-color: var(--green);
      box-shadow: 0 4px 20px rgba(74,222,128,.15);
    }
    .rate-btn.partial {
      border-color: rgba(251,146,60,.3);
    }
    .rate-btn.partial:hover {
      background: var(--orange-soft);
      border-color: var(--orange);
      box-shadow: 0 4px 20px rgba(251,146,60,.15);
    }
    .rate-btn.forgot {
      border-color: rgba(248,113,113,.3);
    }
    .rate-btn.forgot:hover {
      background: var(--red-soft);
      border-color: var(--red);
      box-shadow: 0 4px 20px rgba(248,113,113,.15);
    }
    .rate-btn.selected {
      pointer-events: none;
      opacity: .5;
    }
    .rate-btn.good.selected {
      opacity: 1;
      background: var(--green-soft);
      border-color: var(--green);
    }
    .rate-btn.partial.selected {
      opacity: 1;
      background: var(--orange-soft);
      border-color: var(--orange);
    }
    .rate-btn.forgot.selected {
      opacity: 1;
      background: var(--red-soft);
      border-color: var(--red);
    }
    .rate-result {
      margin-top: 10px;
      padding: 10px 14px;
      border-radius: 8px;
      background: var(--surface2);
      font-size: 13px;
      color: var(--muted);
      animation: fadeIn .3s var(--ease);
    }
    .rate-suggestion {
      margin-top: 8px;
      padding: 8px 12px;
      background: rgba(251,146,60,.08);
      border: 1px solid rgba(251,146,60,.2);
      border-radius: 8px;
      font-size: 12px;
      color: var(--orange);
      animation: fadeIn .3s var(--ease);
    }

    /* ---- Options ---- */
    .opts { display: flex; flex-direction: column; gap: 10px; margin: 16px 0; }
    .opt {
      padding: 14px 18px;
      border: 1px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: all .2s var(--ease);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .opt:hover { border-color: var(--accent); background: var(--accent-glow); }
    .opt-letter {
      width: 32px;
      height: 32px;
      border-radius: 9px;
      background: var(--surface3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 13px;
      flex-shrink: 0;
      transition: all .2s;
    }
    .opt.correct {
      border-color: var(--green2);
      background: var(--green-soft);
    }
    .opt.correct .opt-letter { background: var(--green2); color: white; }
    .opt.wrong {
      border-color: var(--red);
      background: var(--red-soft);
    }
    .opt.wrong .opt-letter { background: var(--red); color: white; }
    .opt.disabled { pointer-events: none; opacity: .6; }

    /* ---- Reveal Button ---- */
    .reveal {
      width: 100%;
      padding: 14px;
      background: transparent;
      border: 1px dashed var(--border2);
      border-radius: 12px;
      color: var(--muted);
      font-weight: 600;
      font-size: 14px;
      font-family: var(--sans);
      cursor: pointer;
      transition: all .2s var(--ease);
      margin-top: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .reveal:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }

    /* ---- Answer Overlay (Floating Card) ---- */
    .answer-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 9999;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      background: rgba(0,0,0,0.5);
      animation: fadeIn 0.3s ease;
    }
    .answer-overlay.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .answer-modal {
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      background: var(--bg);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
    }
    @keyframes popIn {
      0% { transform: scale(0.8); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .answer-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }
    .answer-modal-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--green);
    }
    .answer-modal-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--surface2);
      color: var(--text2);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .answer-modal-close:hover {
      background: var(--red);
      color: white;
    }
    .answer-modal-body {
      padding: 20px;
    }
    
    /* ---- Structured Answer Cards ---- */
    .answer-section {
      margin-bottom: 16px;
      padding: 16px;
      background: var(--surface2);
      border-radius: 12px;
      border-left: 4px solid var(--accent);
    }
    .answer-section:last-child {
      margin-bottom: 0;
    }
    .answer-section-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .answer-section-content {
      color: var(--text2);
      line-height: 1.7;
      font-size: 14px;
    }
    .answer-section-content ul {
      margin: 8px 0;
      padding-left: 20px;
    }
    .answer-section-content li {
      margin-bottom: 6px;
    }
    .answer-section-content code {
      background: var(--surface3);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: var(--mono);
      font-size: 13px;
    }
    .answer-section-content pre {
      background: var(--surface3);
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 10px 0;
      font-size: 13px;
    }
    .answer-section.algo { border-left-color: var(--blue); }
    .answer-section.algo .answer-section-title { color: var(--blue); }
    .answer-section.edge { border-left-color: var(--yellow); }
    .answer-section.edge .answer-section-title { color: var(--yellow); }
    .answer-section.impl { border-left-color: var(--green); }
    .answer-section.impl .answer-section-title { color: var(--green); }
    .answer-section.error { border-left-color: var(--red); }
    .answer-section.error .answer-section-title { color: var(--red); }

    .answer {
      display: block;
      padding: 20px;
      background: linear-gradient(135deg, rgba(74,222,128,.06), rgba(96,165,250,.06));
      border: 1px solid rgba(74,222,128,.15);
      border-radius: 14px;
    }
    .answer-label {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: var(--green);
      margin-bottom: 10px;
    }

    /* ---- Progressive Hint System ---- */
    .hint-btn {
      padding: 10px 20px;
      background: transparent;
      border: 1px solid rgba(251,191,36,.3);
      border-radius: 10px;
      color: var(--yellow);
      font-weight: 600;
      font-size: 13px;
      font-family: var(--sans);
      cursor: pointer;
      transition: all .3s var(--ease);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 16px;
    }
    .hint-btn:hover {
      background: rgba(251,191,36,.08);
      border-color: var(--yellow);
      box-shadow: 0 0 16px rgba(251,191,36,.1);
    }
    .hint-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(251,191,36,.15);
      font-size: 10px;
      font-weight: 800;
    }
    .hint-layer {
      margin-bottom: 12px;
      padding: 14px 18px;
      border-radius: 12px;
      animation: hintReveal .5s var(--ease);
      position: relative;
      overflow: hidden;
    }
    .hint-layer::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(251,191,36,.06) 0%, rgba(129,140,248,.06) 50%, rgba(74,222,128,.06) 100%);
      background-size: 200% 200%;
      animation: hintGradient 4s ease infinite;
      z-index: 0;
    }
    .hint-layer > * { position: relative; z-index: 1; }
    @keyframes hintGradient {
      0%,100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    @keyframes hintReveal {
      from { opacity: 0; max-height: 0; padding: 0 18px; margin: 0; }
      to { opacity: 1; max-height: 200px; }
    }
    .hint-layer {
      border: 1px solid rgba(251,191,36,.15);
    }
    .hint-level-label {
      font-size: 10px;
      font-weight: 800;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: var(--yellow);
      margin-bottom: 6px;
    }
    .hint-content {
      font-size: 13px;
      color: var(--text2);
      line-height: 1.6;
      white-space: pre-wrap;
    }

    /* ---- Hint area in header ---- */
    .hint-area { margin-bottom: 16px; }

    /* ---- Navigation ---- */
    .nav-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 24px 0 48px;
    }

    /* ---- Score Card ---- */
    .score-card {
      display: none;
      text-align: center;
      padding: 48px 24px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 18px;
      margin: 24px 0 48px;
      animation: fadeIn .5s var(--ease);
    }
    .score-card.open { display: block; }
    .score-emoji { font-size: 48px; margin-bottom: 16px; }
    .score-text {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .score-sub { color: var(--muted); font-size: 14px; margin-bottom: 24px; }
    .score-nums {
      display: flex;
      justify-content: center;
      gap: 32px;
      margin: 24px 0;
    }
    .score-n { text-align: center; }
    .score-n .big {
      font-size: 36px;
      font-weight: 900;
      font-family: var(--mono);
    }
    .score-n .lbl {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 4px;
    }

    /* ---- Old Hint (kept for compat) ---- */
    .hint {
      font-size: 13px;
      color: var(--muted);
      padding: 10px 14px;
      background: var(--surface2);
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ---- Responsive ---- */
    @media (max-width: 560px) {
      .pgrid { grid-template-columns: 1fr; }
      .hero { font-size: 24px; }
      .stats { grid-template-columns: repeat(3, 1fr); }
      .stat-num { font-size: 24px; }
      .ex-body { padding: 16px; }
      .compare-view { grid-template-columns: 1fr; }
      .self-rating { flex-direction: column; }
    }

    /* ---- Problem Description ---- */
    .problem-desc {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 18px 20px;
      margin-bottom: 20px;
      font-size: 14px;
      line-height: 1.8;
      color: var(--text2);
      max-height: 300px;
      overflow-y: auto;
    }
    .problem-desc p { margin-bottom: 8px; }
    .problem-desc strong { color: var(--text); }

    /* ---- Inline Fill Blanks ---- */
    .code-block-fill {
      background: #0D0D0F;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      overflow-x: auto;
      font-family: var(--mono);
      font-size: 13px;
      line-height: 2.2;
      margin: 16px 0;
    }
    .code-line { white-space: pre; }

    /* Bug hunt code block */
    .bug-code-block {
      background: #0D0D0F;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0;
      overflow: hidden;
      font-family: var(--mono);
      font-size: 13px;
      margin: 16px 0;
    }
    .bug-line {
      white-space: pre;
      padding: 8px 20px;
      cursor: pointer;
      transition: all .15s var(--ease);
      border-left: 3px solid transparent;
    }
    .bug-line:hover:not(.disabled) {
      background: rgba(129,140,248,.08);
      border-left-color: var(--accent);
    }
    .bug-line.disabled {
      cursor: default;
      opacity: 0.7;
    }
    .bug-line.correct {
      background: var(--green-soft);
      border-left-color: var(--green);
      color: var(--green);
    }
    .bug-line.wrong {
      background: var(--red-soft);
      border-left-color: var(--red);
      color: var(--red);
    }
    .blank-input {
      background: rgba(129,140,248,.1);
      border: 1px solid var(--accent);
      border-bottom: 2px solid var(--accent);
      border-radius: 4px;
      color: var(--text);
      font-family: var(--mono);
      font-size: 13px;
      padding: 2px 8px;
      min-width: 200px;
      outline: none;
      transition: all .2s var(--ease);
    }
    .blank-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
      background: rgba(129,140,248,.15);
    }
    .blank-input.correct {
      border-color: var(--green);
      background: var(--green-soft);
      color: var(--green);
    }
    .blank-input.wrong {
      border-color: var(--red);
      background: var(--red-soft);
      color: var(--red);
    }
    .blank-answer {
      display: none;
      font-size: 12px;
      color: var(--green);
      margin-top: 2px;
      padding-left: 8px;
    }
    .blank-answer.show { display: block; }
    .blank-row { margin: 4px 0; }

    /* ---- Card transitions ---- */
    @keyframes slideOutLeft {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(-100px); }
    }

    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(100px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .card-exit {
      animation: slideOutLeft 0.3s var(--ease) forwards;
    }

    .card-enter {
      animation: slideInRight 0.3s var(--ease) forwards;
    }

    /* ---- Scrollbar ---- */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 99px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--border2); }

    /* ---- Fullscreen Quiz Mode ---- */
    .fs-quiz {
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      transform: translateY(100%);
      transition: transform 0.3s ease-out;
      overflow: hidden;
    }
    .fs-quiz.open {
      transform: translateY(0);
    }
    .fs-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      padding-top: max(16px, env(safe-area-inset-top));
    }
    .fs-close {
      width: 40px;
      height: 40px;
      border: none;
      background: var(--surface2);
      color: var(--text2);
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .fs-close:hover {
      background: var(--surface3);
      color: var(--text);
    }
    .fs-dots {
      display: flex;
      gap: 8px;
    }
    .fs-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--surface3);
      transition: all 0.2s;
    }
    .fs-dot.current {
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
    }
    .fs-dot.done {
      background: var(--green);
    }
    .fs-content {
      flex: 1;
      overflow-y: auto;
      padding: 0 20px 20px;
      padding-bottom: max(20px, env(safe-area-inset-bottom));
    }
    .fs-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
      line-height: 1.3;
    }
    .fs-meta {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    .fs-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      min-height: 300px;
    }
    /* Swipe animation */
    .fs-content.swipe-left {
      animation: swipeLeft 0.3s ease-out;
    }
    @keyframes swipeLeft {
      0% { opacity: 1; transform: translateX(0); }
      50% { opacity: 0; transform: translateX(-30px); }
      51% { transform: translateX(30px); }
      100% { opacity: 1; transform: translateX(0); }
    }

    /* ============================================
       MOBILE-ONLY OPTIMIZATIONS (max-width: 768px)
       ============================================ */
    @media (max-width: 768px) {
      /* === Typography === */
      .fs-title {
        font-size: 22px !important;
        line-height: 1.4;
      }
      .ex-question {
        font-size: 17px !important;
        line-height: 1.6;
      }
      .ex-card {
        padding: 16px !important;
        border-radius: 12px !important;
      }
      
      /* === Touch Targets (min 48px) === */
      .opt {
        min-height: 52px !important;
        padding: 14px 16px !important;
        font-size: 16px !important;
        margin-bottom: 10px !important;
        border-radius: 10px !important;
      }
      .rate-btn {
        min-height: 52px !important;
        padding: 14px 20px !important;
        font-size: 15px !important;
        border-radius: 10px !important;
      }
      .hint-btn {
        min-height: 44px !important;
        padding: 10px 16px !important;
        font-size: 14px !important;
      }
      .submit-btn {
        min-height: 48px !important;
        padding: 14px 24px !important;
        font-size: 16px !important;
      }
      
      /* === Code Blocks - True Full Width === */
      .code-block, .code-block-fill, .bug-code-block, pre {
        font-size: 13px !important;
        line-height: 1.6 !important;
        padding: 12px 16px !important;
        border-radius: 0 !important;
        border-left: none !important;
        border-right: none !important;
        overflow-x: auto !important;
        overflow-y: visible !important;
        -webkit-overflow-scrolling: touch;
        display: block !important;
        /* Break out of all parent padding */
        margin-left: calc(-16px - 16px) !important;
        margin-right: calc(-16px - 16px) !important;
        width: calc(100% + 64px) !important;
        max-width: none !important;
        box-sizing: border-box !important;
      }
      .code-block-fill, .bug-code-block {
        overflow-x: scroll !important;
      }
      .code-line, .bug-line {
        font-size: 13px !important;
        white-space: pre !important;
        display: block !important;
        min-width: max-content;
      }
      pre code {
        display: block;
        white-space: pre !important;
        min-width: max-content;
      }
      /* Remove card padding to let code extend */
      .ex-card {
        overflow: visible !important;
        padding: 16px !important;
        border: none !important;
        background: transparent !important;
      }
      .fs-card {
        overflow: visible !important;
        padding: 0 !important;
        border: none !important;
        background: transparent !important;
      }
      
      /* === Spacing === */
      .fs-content {
        padding: 0 16px 16px !important;
        overflow-x: hidden !important;
      }
      .fs-header {
        padding: 12px 16px !important;
      }
      .fs-meta {
        margin-bottom: 16px !important;
      }
      .tag {
        padding: 6px 12px !important;
        font-size: 13px !important;
      }
      
      /* === Rating Section === */
      .rate-area {
        gap: 10px !important;
      }
      .self-rate {
        padding: 16px !important;
        border-radius: 12px !important;
      }
      .rate-btns {
        gap: 8px !important;
        flex-wrap: wrap;
      }
      
      /* === Progress Dots === */
      .fs-dot {
        width: 12px !important;
        height: 12px !important;
      }
      .fs-dots {
        gap: 10px !important;
      }
      
      /* === Input Areas === */
      .input-area, textarea {
        font-size: 16px !important; /* Prevents iOS zoom */
        padding: 14px !important;
        border-radius: 10px !important;
        min-height: 120px;
      }
      .blank-input {
        font-size: 15px !important;
        padding: 8px 12px !important;
        min-width: 100px;
      }
      
      /* === Main Page Mobile === */
      .header {
        padding: 20px 16px !important;
      }
      .hero {
        font-size: 26px !important;
      }
      .subtitle {
        font-size: 14px !important;
      }
      .stats {
        padding: 16px !important;
        gap: 0 !important;
      }
      .stat-value {
        font-size: 28px !important;
      }
      .btn {
        padding: 14px 20px !important;
        font-size: 15px !important;
        min-height: 48px;
      }
      .btn-row {
        flex-direction: column;
        gap: 10px !important;
      }
      .btn-row .btn {
        width: 100%;
        justify-content: center;
      }
      
      /* === Problem Grid === */
      .pgrid {
        gap: 10px !important;
      }
      .pcard {
        padding: 14px !important;
      }
      .pcard-num {
        font-size: 13px !important;
      }
      .pcard-title {
        font-size: 14px !important;
      }
      
      /* === Better contrast === */
      .ex-type-label {
        font-size: 15px !important;
        padding: 10px 14px !important;
      }
    }

    /* ============ È¶ñÈ°µÊ†∑Âºè ============ */
    .home-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .home-title {
      font-size: 36px;
      font-weight: 900;
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--accent), var(--green));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .home-subtitle {
      color: var(--muted);
      margin-bottom: 48px;
      font-size: 15px;
    }
    .category-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      max-width: 360px;
      width: 100%;
    }
    .category-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 28px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s var(--ease);
    }
    .category-card:hover {
      border-color: var(--accent);
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(129,140,248,.15);
    }
    .category-card:active {
      transform: translateY(-2px);
    }
    .category-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    .category-name {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .category-count {
      color: var(--muted);
      font-size: 14px;
    }
    .category-due {
      color: var(--accent);
      font-size: 13px;
      font-weight: 600;
      margin-top: 6px;
    }
    .home-back-hint {
      margin-top: 48px;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    .home-back-hint:hover {
      border-color: var(--accent);
      color: var(--text);
    }
    /* ËøîÂõûÈ¶ñÈ°µÊåâÈíÆ */
    .back-home-btn {
      position: fixed;
      top: 16px;
      left: 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      width: 44px;
      height: 44px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      transition: all 0.2s;
    }
    .back-home-btn:hover {
      border-color: var(--accent);
      transform: scale(1.05);
    }
    
    /* ============ ÂÖ´ËÇ°ÊñáÂç°ÁâáÊ†∑Âºè ============ */
    .bg-card {
      background: var(--surface);
      border-radius: 20px;
      padding: 32px 24px;
      max-width: 500px;
      margin: 0 auto;
    }
    .bg-category {
      font-size: 12px;
      color: var(--accent);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    .bg-title {
      font-size: 24px;
      font-weight: 800;
      margin-bottom: 20px;
    }
    .bg-question {
      font-size: 17px;
      color: var(--text2);
      line-height: 1.6;
      padding: 16px;
      background: var(--surface2);
      border-radius: 12px;
    }
    .bg-answer {
      margin-top: 24px;
    }
    .bg-section {
      background: var(--surface2);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .bg-section.trap {
      background: var(--orange-soft);
      border: 1px solid rgba(251,146,60,.3);
    }
    .bg-section-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 10px;
      color: var(--accent);
    }
    .bg-section-content {
      font-size: 15px;
      line-height: 1.6;
    }
    .bg-keypoints {
      margin: 0;
      padding-left: 20px;
    }
    .bg-keypoints li {
      margin-bottom: 8px;
      font-size: 15px;
      line-height: 1.5;
    }
    .bg-trap {
      margin-bottom: 12px;
    }
    .bg-trap:last-child {
      margin-bottom: 0;
    }
    .trap-wrong {
      color: var(--red);
      font-size: 14px;
      margin-bottom: 4px;
    }
    .trap-right {
      color: var(--green);
      font-size: 14px;
    }
    .bg-rating {
      margin-top: 24px;
      text-align: center;
    }
    .bg-rating-label {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 12px;
    }
    .bg-rating-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    .rating-btn {
      flex: 1;
      max-width: 100px;
      padding: 14px 16px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .rating-btn.red {
      background: var(--red-soft);
      color: var(--red);
    }
    .rating-btn.orange {
      background: var(--orange-soft);
      color: var(--orange);
    }
    .rating-btn.green {
      background: var(--green-soft);
      color: var(--green);
    }
    .rating-btn:hover {
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <!-- È¶ñÈ°µÂàÜÁ±ªÈÄâÊã© -->
  <div id="homeScreen" class="home-screen">
    <h1 class="home-title">üî• Èù¢ËØï Killer</h1>
    <p class="home-subtitle">ÈÄâÊã©Â§ç‰π†Á±ªÂûã</p>
    
    <div class="category-grid">
      <div class="category-card" onclick="selectCategory('leetcode')">
        <div class="category-icon">üíª</div>
        <div class="category-name">LeetCode</div>
        <div class="category-count" id="lcCount">0 È¢ò</div>
        <div class="category-due" id="lcDue">‰ªäÊó•: 0</div>
      </div>
      
      <div class="category-card" onclick="selectCategory('bagugu')">
        <div class="category-icon">üìö</div>
        <div class="category-name">ÂÖ´ËÇ°Êñá</div>
        <div class="category-count" id="bgCount">Âä†ËΩΩ‰∏≠...</div>
        <div class="category-due" id="bgDue">‰ªäÊó•: ?</div>
      </div>
    </div>
    
    <button class="home-back-hint" onclick="location.reload()">
      Âà∑Êñ∞Êï∞ÊçÆ
    </button>
  </div>

  <div id="app" class="app" style="display:none;">
    <!-- Header -->
    <div class="header">
      <div class="logo">Active Recall</div>
      <h1 class="hero"><span class="hero-gradient">LeetCode Recall Trainer</span></h1>
      <p class="subtitle">‰∏çÁúãÁ≠îÊ°àÔºå‰∏çÁúã‰ª£Á†ÅÔºåÂè™Èù†Â§ßËÑëÊ£ÄÁ¥¢ ‚ú®</p>
    </div>

    <!-- Stats -->
    <div class="stats" id="stats"></div>

    <!-- Install Banner -->
    <div id="installBanner" style="display:none;margin:20px 0;padding:16px 20px;background:linear-gradient(135deg,rgba(129,140,248,.15),rgba(74,222,128,.1));border:1px solid var(--accent);border-radius:14px;text-align:center;">
      <div style="font-size:15px;font-weight:600;margin-bottom:10px;">üì≤ ÂÆâË£Ö‰∏∫ AppÔºåÁ¶ªÁ∫ø‰πüËÉΩÂà∑È¢òÔºÅ</div>
      <button id="installBtn" class="btn btn-primary" style="margin:0 auto;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
        ÂÆâË£Ö App
      </button>
    </div>

    <!-- Actions -->
    <div class="btn-row">
      <button class="btn btn-primary" onclick="smartRecommend()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
        ÂºÄÂßãÊØèÊó•Â§ç‰π†
      </button>
      <button class="btn btn-ghost" onclick="toggleProblems()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
        ÈÄâÊã©È¢òÁõÆ
      </button>
      <button class="btn btn-ghost" onclick="resetTodaySession()" style="color:var(--orange);">
        üîÑ ÈáçÁΩÆ
      </button>
    </div>

    <!-- Problem Selection -->
    <div id="problemSection">
      <div class="section-title">Â∑≤Âà∑È¢òÁõÆ</div>
      <div class="pgrid" id="problemGrid"></div>
    </div>

    <!-- Quiz Area -->
    <div id="quizArea">
      <div class="quiz-top">
        <div class="quiz-info">
          <div class="quiz-name" id="quizName"></div>
          <div class="quiz-meta">
            <span class="tag" id="quizDiff"></span>
            <span class="tag tag-cat" id="quizCat"></span>
          </div>
        </div>
        <button class="btn btn-sm btn-ghost" onclick="closeQuiz()">‚úï ÂÖ≥Èó≠</button>
      </div>
      <div class="stepper" id="stepper"></div>
      <div id="exContainer"></div>
      <div class="nav-row" id="navRow"></div>
      <div class="score-card" id="scoreCard"></div>
    </div>
  </div>

  <!-- Fullscreen Quiz Mode (Mobile) -->
  <div id="fullscreenQuiz" class="fs-quiz">
    <div class="fs-header">
      <button class="fs-close" onclick="closeFullscreen()">‚úï</button>
      <div class="fs-dots" id="fsDots"></div>
    </div>
    <div class="fs-content" id="fsContent">
      <!-- Quiz content injected here -->
    </div>
  </div>

  <script>
    // ---- Â∑•ÂÖ∑ÂáΩÊï∞ÔºàÊèêÂâçÂÆö‰πâÔºâ----
    function getTodayStr() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    const PROGRESS_KEY = 'lc-recall-progress';
    
    function loadProgressLocal() {
      try {
        return JSON.parse(localStorage.getItem(PROGRESS_KEY) || '{}');
      } catch (e) { return {}; }
    }
    
    function saveProgressLocal(data) {
      localStorage.setItem(PROGRESS_KEY, JSON.stringify(data));
    }

    // ---- È¶ñÈ°µ & ÂàÜÁ±ª ----
    let currentCategory = null;
    let baguguData = [];
    
    async function loadBagugu() {
      console.log('loadBagugu: starting...');
      try {
        const res = await fetch('./bagugu.json');
        console.log('loadBagugu: fetch response', res.status);
        if (!res.ok) {
          console.error('loadBagugu: fetch failed', res.status);
          return;
        }
        baguguData = await res.json();
        console.log('loadBagugu: loaded', baguguData.length, 'items');
        
        const bgCountEl = document.getElementById('bgCount');
        const bgDueEl = document.getElementById('bgDue');
        console.log('loadBagugu: elements', bgCountEl, bgDueEl);
        
        if (bgCountEl) {
          bgCountEl.textContent = baguguData.length + ' È¢ò';
        }
        
        // ËÆ°ÁÆó‰ªäÊó•Âà∞Êúü
        const today = getTodayStr();
        const progress = loadProgressLocal();
        let bgDue = 0;
        for (const item of baguguData) {
          const p = progress[`bg-${item.id}`];
          if (!p || p.nextReview <= today) bgDue++;
        }
        
        if (bgDueEl) {
          bgDueEl.textContent = '‰ªäÊó•: ' + bgDue;
        }
        console.log('loadBagugu: done, due=', bgDue);
      } catch (e) {
        console.error('loadBagugu error:', e);
        const bgCountEl = document.getElementById('bgCount');
        if (bgCountEl) {
          bgCountEl.textContent = 'Âä†ËΩΩÂ§±Ë¥•';
          bgCountEl.style.color = 'red';
        }
      }
    }
    
    async function selectCategory(category) {
      currentCategory = category;
      document.getElementById('homeScreen').style.display = 'none';
      
      // Ê∑ªÂä†ËøîÂõûÊåâÈíÆ
      if (!document.querySelector('.back-home-btn')) {
        const backBtn = document.createElement('button');
        backBtn.className = 'back-home-btn';
        backBtn.innerHTML = '‚Üê';
        backBtn.onclick = backToHome;
        document.body.appendChild(backBtn);
      }
      document.querySelector('.back-home-btn').style.display = 'flex';
      
      if (category === 'leetcode') {
        // LeetCode ‰ΩøÁî® app ÁïåÈù¢
        document.getElementById('app').style.display = 'block';
        document.querySelector('.hero-gradient').textContent = 'LeetCode Recall Trainer';
        
        // Ê∏ÖÁ©∫ÊóßÂÜÖÂÆπ
        document.getElementById('stats').innerHTML = '';
        document.getElementById('problemGrid').innerHTML = '';
        document.getElementById('quizArea').classList.remove('open');
        
        window.currentSession = await initDailySession(loadProgressLocal());
        console.log('[DEBUG] currentSession set:', window.currentSession);
        
        // Safety check: if session is still empty but we have problems, force regenerate
        if ((!window.currentSession || window.currentSession.total === 0) && problems.length > 0) {
          console.log('[DEBUG] Session still empty, forcing regeneration');
          clearSession();
          window.currentSession = generateDailyQueue(loadProgressLocal() || {});
          saveSession(window.currentSession);
        }
        
        renderStats();
        renderProblems();
      } else if (category === 'bagugu') {
        // ÂÖ´ËÇ°ÊñáÁõ¥Êé•ËøõÂÖ•ÂÖ®Â±èÊ®°ÂºèÔºå‰∏çÊòæÁ§∫ app ÁïåÈù¢
        document.getElementById('app').style.display = 'none';
        initBaguguSession();
      }
    }
    
    function backToHome() {
      document.getElementById('homeScreen').style.display = 'flex';
      document.getElementById('app').style.display = 'none';
      if (document.querySelector('.back-home-btn')) {
        document.querySelector('.back-home-btn').style.display = 'none';
      }
      // ÂÖ≥Èó≠ÂÖ®Â±èÊ®°Âºè
      if (document.getElementById('fullscreenOverlay')) {
        document.getElementById('fullscreenOverlay').remove();
      }
      currentCategory = null;
    }
    
    // ÂÖ´ËÇ°ÊñáÈÄâ‰∏≠ÁöÑ‰∏ªÈ¢ò
    let selectedBaguguTopics = [];
    
    function initBaguguSession() {
      console.log('initBaguguSession: baguguData.length=', baguguData.length);
      
      // Â¶ÇÊûúÊï∞ÊçÆ‰∏∫Á©∫ÔºåÊòæÁ§∫ÈîôËØØ
      if (!baguguData || baguguData.length === 0) {
        showBaguguError('È¢òÂ∫ìÂä†ËΩΩÂ§±Ë¥•', `baguguData.length = ${baguguData ? baguguData.length : 'null'}`);
        return;
      }
      
      // ÊòæÁ§∫‰∏ªÈ¢òÈÄâÊã©ÁïåÈù¢
      showBaguguTopicSelector();
    }
    
    function showBaguguError(title, detail) {
      const overlay = document.createElement('div');
      overlay.id = 'fullscreenOverlay';
      overlay.className = 'fullscreen-overlay';
      overlay.innerHTML = `
        <button class="fs-close" onclick="backToHome()">‚úï</button>
        <div style="text-align:center;padding:60px 20px;">
          <div style="font-size:48px;margin-bottom:16px;">‚ö†Ô∏è</div>
          <div style="font-size:20px;font-weight:700;color:var(--red);">${title}</div>
          <div style="color:var(--muted);margin-top:8px;">${detail}</div>
          <button class="btn btn-primary" onclick="location.reload()" style="margin-top:20px;">Âà∑Êñ∞ÈáçËØï</button>
        </div>
      `;
      document.body.appendChild(overlay);
    }
    
    function showBaguguTopicSelector() {
      // Ëé∑ÂèñÊâÄÊúâÂ§ßÁ±ªÂèäÂÖ∂È¢òÁõÆÊï∞ÈáèÔºàÊåâ "/" ÂàÜÂâ≤ÂèñÁ¨¨‰∏ÄÈÉ®ÂàÜÔºâ
      const topicCounts = {};
      const progress = loadProgressLocal();
      const today = getTodayStr();
      
      baguguData.forEach(item => {
        const fullCat = item.category || 'Êú™ÂàÜÁ±ª';
        // ÂèñÂ§ßÁ±ªÔºà"/" ÂâçÁöÑÈÉ®ÂàÜÔºâ
        const mainCat = fullCat.split('/')[0].trim();
        if (!topicCounts[mainCat]) {
          topicCounts[mainCat] = { total: 0, due: 0, subCategories: new Set() };
        }
        topicCounts[mainCat].total++;
        topicCounts[mainCat].subCategories.add(fullCat);
        const p = progress[`bg-${item.id}`];
        if (!p || p.nextReview <= today) {
          topicCounts[mainCat].due++;
        }
      });
      
      const topics = Object.keys(topicCounts).sort();
      
      // ÈªòËÆ§ÂÖ®ÈÄâ
      selectedBaguguTopics = [...topics];
      
      const overlay = document.createElement('div');
      overlay.id = 'fullscreenOverlay';
      overlay.className = 'fullscreen-overlay';
      overlay.style.cssText = 'display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;';
      
      const topicCards = topics.map(topic => {
        const icon = getTopicIcon(topic);
        const count = topicCounts[topic];
        const subCats = [...count.subCategories].map(c => c.split('/')[1] || c).join('„ÄÅ');
        return `
          <div class="topic-card selected" data-topic="${topic}" onclick="toggleBaguguTopic(this, '${topic}')">
            <div class="topic-icon">${icon}</div>
            <div class="topic-info">
              <div class="topic-name">${topic}</div>
              <div class="topic-sub">${subCats}</div>
              <div class="topic-count">${count.total} È¢ò ¬∑ ${count.due} ÂæÖÂ§ç‰π†</div>
            </div>
            <div class="topic-check">‚úì</div>
          </div>
        `;
      }).join('');
      
      overlay.innerHTML = `
        <button class="fs-close" onclick="backToHome()">‚úï</button>
        <div style="width:100%;max-width:400px;">
          <div style="text-align:center;margin-bottom:24px;">
            <div style="font-size:32px;margin-bottom:8px;">üéØ</div>
            <div style="font-size:20px;font-weight:700;">ÈÄâÊã©Â§ç‰π†‰∏ªÈ¢ò</div>
            <div style="color:var(--muted);font-size:14px;margin-top:4px;">ÁÇπÂáªÈÄâÊã©/ÂèñÊ∂àÔºåÂèØÂ§öÈÄâ</div>
          </div>
          
          <div id="topicList" style="display:flex;flex-direction:column;gap:10px;margin-bottom:24px;">
            ${topicCards}
          </div>
          
          <div style="display:flex;gap:10px;">
            <button class="btn btn-ghost" onclick="toggleAllBaguguTopics()" style="flex:1;">
              ÂÖ®ÈÄâ/ÂèñÊ∂à
            </button>
            <button class="btn btn-primary" onclick="startBaguguWithTopics()" style="flex:2;">
              ÂºÄÂßãÂ§ç‰π†
            </button>
          </div>
        </div>
        
        <style>
          .topic-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all .2s var(--ease);
          }
          .topic-card:hover {
            border-color: var(--accent);
          }
          .topic-card.selected {
            border-color: var(--accent);
            background: var(--accent-glow);
          }
          .topic-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface2);
            border-radius: 10px;
          }
          .topic-info {
            flex: 1;
          }
          .topic-name {
            font-weight: 600;
            font-size: 15px;
          }
          .topic-sub {
            font-size: 12px;
            color: var(--accent);
            margin-top: 2px;
          }
          .topic-count {
            font-size: 11px;
            color: var(--muted);
            margin-top: 4px;
          }
          .topic-check {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            opacity: 0;
            transform: scale(0.8);
            transition: all .2s var(--ease);
          }
          .topic-card.selected .topic-check {
            opacity: 1;
            transform: scale(1);
          }
        </style>
      `;
      
      document.body.appendChild(overlay);
    }
    
    function getTopicIcon(topic) {
      const icons = {
        'iOS': 'üì±',
        'Á≥ªÁªüËÆæËÆ°': 'üèóÔ∏è',
        'ÁΩëÁªú': 'üåê',
        'Êï∞ÊçÆÂ∫ì': 'üíæ',
        'ÁÆóÊ≥ï': 'üßÆ',
        'Êìç‰ΩúÁ≥ªÁªü': 'üñ•Ô∏è',
        'Java': '‚òï',
        'Python': 'üêç',
        'ÂâçÁ´Ø': 'üé®',
        'ÂêéÁ´Ø': '‚öôÔ∏è',
        'ÈªòËÆ§': 'üìö'
      };
      return icons[topic] || icons['ÈªòËÆ§'];
    }
    
    function toggleBaguguTopic(el, topic) {
      el.classList.toggle('selected');
      if (el.classList.contains('selected')) {
        if (!selectedBaguguTopics.includes(topic)) {
          selectedBaguguTopics.push(topic);
        }
      } else {
        selectedBaguguTopics = selectedBaguguTopics.filter(t => t !== topic);
      }
    }
    
    function toggleAllBaguguTopics() {
      const cards = document.querySelectorAll('.topic-card');
      const allSelected = selectedBaguguTopics.length === cards.length;
      
      if (allSelected) {
        // ÂèñÊ∂àÂÖ®ÈÄâ
        selectedBaguguTopics = [];
        cards.forEach(card => card.classList.remove('selected'));
      } else {
        // ÂÖ®ÈÄâ
        selectedBaguguTopics = [];
        cards.forEach(card => {
          card.classList.add('selected');
          selectedBaguguTopics.push(card.dataset.topic);
        });
      }
    }
    
    function startBaguguWithTopics() {
      if (selectedBaguguTopics.length === 0) {
        alert('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™‰∏ªÈ¢òÔºÅ');
        return;
      }
      
      // ÁßªÈô§ÈÄâÊã©ÁïåÈù¢
      const overlay = document.getElementById('fullscreenOverlay');
      if (overlay) overlay.remove();
      
      // Ê†πÊçÆÈÄâ‰∏≠ÁöÑÂ§ßÁ±ªÁ≠õÈÄâÈ¢òÁõÆ
      const progress = loadProgressLocal();
      const today = getTodayStr();
      
      const filteredItems = baguguData.filter(item => {
        const fullCat = item.category || 'Êú™ÂàÜÁ±ª';
        const mainCat = fullCat.split('/')[0].trim();
        return selectedBaguguTopics.includes(mainCat);
      });
      
      // ÊâæÂà∞ÊúüÁöÑÂÖ´ËÇ°Êñá
      const dueItems = filteredItems.filter(item => {
        const p = progress[`bg-${item.id}`];
        return !p || p.nextReview <= today;
      });
      
      console.log('startBaguguWithTopics: selectedTopics=', selectedBaguguTopics);
      console.log('startBaguguWithTopics: filteredItems=', filteredItems.length);
      console.log('startBaguguWithTopics: dueItems=', dueItems.length);
      
      // ÈöèÊú∫ÈÄâ 10 ‰∏™
      const shuffled = dueItems.sort(() => Math.random() - 0.5);
      const selected = shuffled.slice(0, 10);
      
      if (selected.length === 0) {
        const msg = dueItems.length === 0 
          ? `ÊâÄÈÄâ‰∏ªÈ¢ò (${selectedBaguguTopics.join(', ')}) ‰ªäÊó•Â∑≤Â§ç‰π†ÂÆåÊàêÔºÅ`
          : 'Ê≤°ÊúâÂæÖÂ§ç‰π†ÁöÑÈ¢òÁõÆ';
        
        const completeOverlay = document.createElement('div');
        completeOverlay.id = 'fullscreenOverlay';
        completeOverlay.className = 'fullscreen-overlay';
        completeOverlay.innerHTML = `
          <button class="fs-close" onclick="backToHome()">‚úï</button>
          <div style="text-align:center;padding:60px 20px;">
            <div style="font-size:48px;margin-bottom:16px;">üéâ</div>
            <div style="font-size:20px;font-weight:700;">${msg}</div>
            <div style="color:var(--muted);margin-top:8px;">
              ÊÄªÈ¢òÊï∞: ${filteredItems.length}, ÂæÖÂ§ç‰π†: ${dueItems.length}
            </div>
            <button class="btn btn-primary" onclick="backToHome()" style="margin-top:20px;">ËøîÂõûÈ¶ñÈ°µ</button>
          </div>
        `;
        document.body.appendChild(completeOverlay);
        return;
      }
      
      // ÁîüÊàêÁªÉ‰π†
      const exercises = selected.map(item => ({
        type: 'concept-recall',
        item: item,
        question: item.question,
        keyPoints: item.keyPoints,
        concept: item.concept,
        explanation: item.explanation
      }));
      
      // ÂêØÂä®ÂÖ®Â±èÊ®°Âºè
      startBaguguFullscreen(exercises);
    }
    
    function startBaguguFullscreen(exercises) {
      let current = 0;
      const total = exercises.length;
      
      const overlay = document.createElement('div');
      overlay.id = 'fullscreenOverlay';
      overlay.className = 'fullscreen-overlay';
      overlay.innerHTML = `
        <button class="fs-close" onclick="backToHome()">‚úï</button>
        <div class="fs-progress">
          ${exercises.map((_, i) => `<div class="fs-dot${i === 0 ? ' active' : ''}"></div>`).join('')}
        </div>
        <div class="fs-content" id="bgContent"></div>
      `;
      document.body.appendChild(overlay);
      
      function showExercise(idx) {
        const ex = exercises[idx];
        const container = document.getElementById('bgContent');
        
        // Êõ¥Êñ∞ËøõÂ∫¶ÁÇπ
        document.querySelectorAll('.fs-dot').forEach((dot, i) => {
          dot.className = 'fs-dot' + (i < idx ? ' done' : '') + (i === idx ? ' active' : '');
        });
        
        container.innerHTML = `
          <div class="bg-card">
            <div class="bg-category">${ex.item.category}</div>
            <div class="bg-title">${ex.item.title}</div>
            <div class="bg-question">‚ùì ${ex.question}</div>
            <button class="btn btn-primary" onclick="showBgAnswer(${idx})" style="margin-top:24px;">
              ÊòæÁ§∫Á≠îÊ°à
            </button>
          </div>
        `;
      }
      
      window.showBgAnswer = function(idx) {
        const ex = exercises[idx];
        const container = document.getElementById('bgContent');
        
        container.innerHTML = `
          <div class="bg-card">
            <div class="bg-category">${ex.item.category}</div>
            <div class="bg-title">${ex.item.title}</div>
            <div class="bg-question">‚ùì ${ex.question}</div>
            
            <div class="bg-answer">
              <div class="bg-section">
                <div class="bg-section-title">üí° Ê¶ÇÂøµ</div>
                <div class="bg-section-content">${ex.concept}</div>
              </div>
              
              <div class="bg-section">
                <div class="bg-section-title">üìù Á≠îÊ°àË¶ÅÁÇπ</div>
                <ol class="bg-keypoints">
                  ${ex.keyPoints.map(p => `<li>${p}</li>`).join('')}
                </ol>
              </div>
              
              ${ex.item.traps && ex.item.traps.length > 0 ? `
              <div class="bg-section trap">
                <div class="bg-section-title">‚ö†Ô∏è Â∏∏ËßÅÈô∑Èò±</div>
                ${ex.item.traps.map(t => `
                  <div class="bg-trap">
                    <div class="trap-wrong">‚ùå ${t.wrong}</div>
                    <div class="trap-right">‚úÖ ${t.right}</div>
                  </div>
                `).join('')}
              </div>
              ` : ''}
            </div>
            
            <div class="bg-rating">
              <div class="bg-rating-label">‰Ω†ËÆ∞ÂæóÂ§öÂ∞ëÔºü</div>
              <div class="bg-rating-buttons">
                <button class="rating-btn red" onclick="rateBg(${idx}, 1)">‚ùå Âøò‰∫Ü</button>
                <button class="rating-btn orange" onclick="rateBg(${idx}, 3)">ü§î ÈÉ®ÂàÜ</button>
                <button class="rating-btn green" onclick="rateBg(${idx}, 5)">‚úÖ ËÆ∞Âæó</button>
              </div>
            </div>
          </div>
        `;
      };
      
      window.rateBg = function(idx, rating) {
        const ex = exercises[idx];
        const progress = loadProgressLocal();
        const key = `bg-${ex.item.id}`;
        
        // SM-2 ÁÆÄÂåñÁâà
        const old = progress[key] || { ease: 2.5, interval: 1, reps: 0 };
        let { ease, interval, reps } = old;
        
        if (rating >= 3) {
          if (reps === 0) interval = 1;
          else if (reps === 1) interval = 3;
          else interval = Math.round(interval * ease);
          reps++;
          ease = Math.max(1.3, ease + 0.1 - (5 - rating) * (0.08 + (5 - rating) * 0.02));
        } else {
          reps = 0;
          interval = 1;
        }
        
        const next = new Date();
        next.setDate(next.getDate() + interval);
        
        progress[key] = {
          ease,
          interval,
          reps,
          lastReview: getTodayStr(),
          nextReview: next.toISOString().split('T')[0],
          rating
        };
        
        saveProgressLocal(progress);
        
        // ‰∏ã‰∏ÄÈ¢ò
        if (idx + 1 < total) {
          showExercise(idx + 1);
        } else {
          // ÂÆåÊàê
          document.getElementById('bgContent').innerHTML = `
            <div style="text-align:center;padding:40px;">
              <div style="font-size:64px;margin-bottom:20px;">üéâ</div>
              <div style="font-size:24px;font-weight:700;">‰ªäÊó•Â§ç‰π†ÂÆåÊàêÔºÅ</div>
              <div style="color:var(--muted);margin-top:12px;">ÂÖ±Â§ç‰π† ${total} ‰∏™Áü•ËØÜÁÇπ</div>
              <button class="btn btn-primary" onclick="backToHome()" style="margin-top:32px;">
                ËøîÂõûÈ¶ñÈ°µ
              </button>
            </div>
          `;
        }
      };
      
      showExercise(0);
    }

    // ---- State ----
    let problems = [];
    let quiz = null;
    let step = 0;
    let answers = {};
    let timers = {};
    let hintLevel = 0; // progressive hints: 0=none, 1/2/3=revealed
    let ratings = {}; // step -> rating submitted
    let progressData = {};
    let reviewData = null;

    function computeReviewData(progress) {
      const today = getTodayStr();
      const due = [];
      const upcoming = [];
      
      for (const [numStr, problemData] of Object.entries(progress)) {
        for (const [type, data] of Object.entries(problemData)) {
          if (data.nextReview && data.nextReview <= today) {
            due.push({ number: parseInt(numStr), type, ...data });
          } else if (data.nextReview) {
            upcoming.push({ number: parseInt(numStr), type, ...data });
          }
        }
      }
      return { due, upcoming, today };
    }

    // ---- Init ----
    async function init() {
      try {
        console.log('Init starting...');
        
        // Load problems from static JSON
        const probRes = await fetch('problems.json');
        if (!probRes.ok) throw new Error('Failed to fetch problems.json: ' + probRes.status);
        problems = await probRes.json();
        console.log('Loaded', problems.length, 'problems');
        
        // Load bagugu data
        console.log('init: calling loadBagugu...');
        await loadBagugu();
        console.log('init: loadBagugu done, baguguData.length=', baguguData.length);
        
        // Load progress from localStorage
        progressData = { progress: loadProgressLocal() };
        
        // Compute review data locally
        reviewData = computeReviewData(progressData.progress);
        
        // Êõ¥Êñ∞È¶ñÈ°µ LeetCode ÁªüËÆ°
        document.getElementById('lcCount').textContent = problems.length + ' È¢ò';
        const lcDue = reviewData && reviewData.due ? reviewData.due.length : 0;
        document.getElementById('lcDue').textContent = '‰ªäÊó•: ' + lcDue;
        
        // ÊòæÁ§∫È¶ñÈ°µÔºå‰∏çËá™Âä®ÂºÄÂßãÂ§ç‰π†
        document.getElementById('homeScreen').style.display = 'flex';
        document.getElementById('app').style.display = 'none';
        
        console.log('Init complete! Showing home screen.');
      } catch (err) {
        console.error('Init failed:', err);
        document.body.innerHTML = '<div style="color:red;padding:40px;text-align:center;"><h2>Âä†ËΩΩÂ§±Ë¥•</h2><p>' + err.message + '</p><button onclick="location.reload()">Âà∑Êñ∞ÈáçËØï</button></div>';
      }
    }

    function renderStats() {
      const session = window.currentSession || { current: 0, total: 0 };
      const progressPct = session.total > 0 ? Math.round((session.current / session.total) * 100) : 0;
      const remaining = Math.max(0, session.total - session.current);
      
      const total = problems.length;
      
      document.getElementById('stats').innerHTML = `
        <div class="stat">
          <div class="stat-num green">${session.current}</div>
          <div class="stat-label">Â∑≤ÂÆåÊàê</div>
        </div>
        <div class="stat">
          <div class="stat-num orange">${remaining}</div>
          <div class="stat-label">Êú¨ËΩÆÂâ©‰Ωô</div>
        </div>
        <div class="stat">
          <div class="stat-num purple">${total}</div>
          <div class="stat-label">ÊÄªÈ¢òÊï∞</div>
        </div>
      `;
      
      // Update or create progress bar
      const statsEl = document.getElementById('stats');
      let progressBar = document.getElementById('daily-progress-bar');
      
      if (!progressBar) {
        progressBar = document.createElement('div');
        progressBar.id = 'daily-progress-bar';
        progressBar.style.cssText = 'margin:20px 0;padding:0 20px';
        statsEl.parentElement.insertBefore(progressBar, statsEl.nextSibling);
      }
      
      progressBar.innerHTML = `
        <div style="font-size:13px;color:var(--muted);margin-bottom:8px;display:flex;justify-content:space-between">
          <span>‰ªäÊó•ËøõÂ∫¶</span>
          <span>${session.current} / ${session.total} (${progressPct}%)</span>
        </div>
        <div style="height:4px;background:var(--surface3);border-radius:2px;overflow:hidden">
          <div style="width:${progressPct}%;height:100%;background:linear-gradient(90deg,var(--accent),var(--green));transition:width .3s var(--ease)"></div>
        </div>
      `;
    }

    function renderProblems() {
      // Build a set of due problem numbers
      const dueNums = new Set();
      const masteredNums = new Set();
      if (reviewData) {
        reviewData.due.forEach(p => dueNums.add(p.number));
      }
      if (progressData && progressData.progress) {
        for (const [key, entry] of Object.entries(progressData.progress)) {
          if (Object.values(entry).some(ex => ex.interval >= 21)) {
            masteredNums.add(parseInt(key));
          }
        }
      }

      document.getElementById('problemGrid').innerHTML = problems.map(p => {
        let statusHtml = '';
        if (dueNums.has(p.number)) {
          statusHtml = '<span class="pcard-status due">ÂæÖÂ§ç‰π†</span>';
        } else if (masteredNums.has(p.number)) {
          statusHtml = '<span class="pcard-status mastered">Â∑≤ÊéåÊè°</span>';
        }
        return `
          <div class="pcard" onclick="startQuiz(${p.number})">
            ${statusHtml}
            <div class="pcard-num">#${String(p.number).padStart(3,'0')}</div>
            <div class="pcard-title">${p.title}</div>
            <div class="pcard-tags">
              <span class="tag tag-${p.difficulty.toLowerCase()}">${p.difficulty}</span>
              <span class="tag tag-cat">${p.category.replace(/^\d+-/,'')}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleProblems() {
      document.getElementById('problemSection').classList.toggle('open');
    }

    // ---- Smart Recommend (use daily session queue) ----
    async function smartRecommend() {
      // Ê£ÄÊü•ÂΩìÂâçÁ±ªÂà´
      if (currentCategory !== 'leetcode') {
        console.log('[DEBUG] smartRecommend called but category is:', currentCategory);
        if (currentCategory === 'bagugu') {
          // ÂÖ´ËÇ°ÊñáÂ∫îËØ•Áî®ÂÖ®Â±èÊ®°Âºè
          initBaguguSession();
        }
        return;
      }
      
      let session = window.currentSession;
      
      console.log('[DEBUG] smartRecommend called, session:', session);
      
      if (!session || session.total === 0) {
        console.log('[DEBUG] Session empty or total=0, attempting regeneration');
        console.log('[DEBUG] problems.length:', problems.length);
        
        // Try to regenerate if we have problems but no session
        if (problems.length > 0) {
          console.log('[DEBUG] Regenerating daily queue...');
          clearSession();
          session = generateDailyQueue(loadProgressLocal() || {});
          saveSession(session);
          window.currentSession = session;
          renderStats();
          console.log('[DEBUG] Regenerated session:', session);
        }
        
        if (!session || session.total === 0) {
          alert('È¢òÂ∫ì‰∏∫Á©∫ÔºåËØ∑ÂÖàÊ∑ªÂä†È¢òÁõÆÔºÅ\n\nË∞ÉËØï‰ø°ÊÅØ:\n- problems.length: ' + problems.length + '\n- session: ' + JSON.stringify(session));
          return;
        }
      }
      
      if (session.current >= session.total) {
        // All done or no session - show summary
        showSessionSummary();
        return;
      }
      
      // Get current item from queue
      const currentItem = session.queue[session.current];
      
      if (!currentItem) {
        console.error('No current item in queue');
        return;
      }
      
      // Show the card for this problem and type
      showCard(currentItem.id, currentItem.type);
    }

    // ---- Show Session Summary ----
    function showSessionSummary() {
      const session = window.currentSession;
      if (!session) return;
      
      // Calculate stats
      const completed = session.queue.filter(item => item.status === 'completed');
      const byRating = {
        good: completed.filter(item => item.rating === 'good').length,
        partial: completed.filter(item => item.rating === 'partial').length,
        forgot: completed.filter(item => item.rating === 'forgot').length
      };
      const accuracy = completed.length > 0 
        ? Math.round((byRating.good / completed.length) * 100) 
        : 0;
      
      // Build summary HTML
      const summaryHtml = `
        <div style="text-align:center;padding:60px 20px">
          <div style="font-size:48px;margin-bottom:20px">üéâ</div>
          <div style="font-size:28px;font-weight:700;margin-bottom:12px">‰ªäÊó•‰ªªÂä°ÂÆåÊàêÔºÅ</div>
          <div style="color:var(--muted);margin-bottom:40px">Keep up the great work!</div>
          
          <div style="background:var(--surface2);border-radius:12px;padding:24px;margin-bottom:24px">
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px">
              <div>
                <div style="font-size:32px;font-weight:700;color:var(--green)">${completed.length}</div>
                <div style="font-size:13px;color:var(--muted)">ÂÆåÊàêÈ¢òÊï∞</div>
              </div>
              <div>
                <div style="font-size:32px;font-weight:700;color:var(--accent)">${accuracy}%</div>
                <div style="font-size:13px;color:var(--muted)">Ê≠£Á°ÆÁéá</div>
              </div>
              <div>
                <div style="font-size:32px;font-weight:700;color:var(--blue)">${byRating.good}</div>
                <div style="font-size:13px;color:var(--muted)">ÂÆåÂÖ®ÊéåÊè°</div>
              </div>
            </div>
          </div>
          
          <div style="display:flex;gap:12px;justify-content:center">
            <button class="btn-primary" onclick="startNewRound()">
              <i data-lucide="refresh-cw"></i> ÂÜçÊù•‰∏ÄËΩÆ
            </button>
            <button class="btn-secondary" onclick="location.reload()">
              <i data-lucide="home"></i> ËøîÂõûÈ¶ñÈ°µ
            </button>
          </div>
        </div>
      `;
      
      // Replace main content
      document.querySelector('.app').innerHTML = summaryHtml;
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function startNewRound() {
      clearSession();
      location.reload();
    }

    // ---- Show Card (single exercise type) ----
    async function showCard(id, type) {
      // Load only the specified exercise type
      await startQuiz(id, type);
    }

    // ---- Generate Quiz Locally ----
    function generateQuizFromProblem(prob) {
      const exercises = [];
      
      // 1. Recall
      exercises.push({
        type: 'recall',
        emoji: '1Ô∏è‚É£',
        title: 'Ëß£È¢òÊÄùË∑ØÂõûÂøÜ',
        timeLimit: '60-90Áßí',
        description: prob.descSummary || '',
        question: 'ËØ∑ÊèèËø∞‰Ω†ÁöÑËß£È¢òÊÄùË∑ØÔºàÁî®‰ªÄ‰πàÁÆóÊ≥ïÔºü‰∏∫‰ªÄ‰πàÔºüÂÖ≥ÈîÆÊ≠•È™§ÊòØ‰ªÄ‰πàÔºüÔºâ',
        hint: 'ÊÄùË∑Ø > ‰ª£Á†ÅÔºåÊèèËø∞ÊñπÊ≥ïÂíåÂÖ≥ÈîÆÊ≠•È™§',
        answer: prob.keyPoints || 'ËØ∑ÂèÇËÄÉÁ¨îËÆ∞'
      });
      
      // 2. Fill (simplified)
      const code = prob.codeBlocks && prob.codeBlocks[0] ? prob.codeBlocks[0] : '';
      const lines = code.split('\n');
      const outputLines = lines.map((line, i) => ({ type: 'code', content: line }));
      exercises.push({
        type: 'fill',
        emoji: '2Ô∏è‚É£',
        title: 'ÂÖ≥ÈîÆÈÄªËæëÂ°´Á©∫',
        timeLimit: '30-60Áßí',
        question: 'ËØ∑ÂõûÂøÜËøôÈÅìÈ¢òÁöÑÊ†∏ÂøÉ‰ª£Á†ÅÈÄªËæë',
        lines: outputLines,
        blanks: [],
        fullCode: code,
        answer: '```python\n' + code + '\n```'
      });
      
      // 3. Choice
      const techOptions = {
        '04-Hash-Table': ['ÂìàÂ∏åË°®', 'ÊéíÂ∫è', '‰∫åÂàÜÊü•Êâæ', 'Êï∞ÁªÑÈÅçÂéÜ'],
        '06-Tree': ['DFSÈÄíÂΩí', 'BFSÂ±ÇÂ∫è', 'ÂèåÊåáÈíà', 'Âä®ÊÄÅËßÑÂàí'],
        '03-Sliding-Window': ['ÊªëÂä®Á™óÂè£', 'ÂèåÊåáÈíà', 'ÂâçÁºÄÂíå', 'ÂàÜÊ≤ª'],
        'default': ['ÂìàÂ∏åË°®', 'ÂèåÊåáÈíà', 'ÈÄíÂΩí', 'Âä®ÊÄÅËßÑÂàí']
      };
      const opts = techOptions[prob.category] || techOptions['default'];
      exercises.push({
        type: 'choice',
        emoji: '3Ô∏è‚É£',
        title: 'Ê®°ÂºèËØÜÂà´',
        timeLimit: '20Áßí',
        question: `${prob.fullTitle} ‰ΩøÁî®ÁöÑÊ†∏ÂøÉÁÆóÊ≥ïÊòØÔºü`,
        options: opts.sort(() => Math.random() - 0.5),
        correctIndex: 0
      });
      
      // 4. Bug (Êîπ‰∏∫ÂõûÂøÜÂ∏∏ËßÅÈîôËØØ)
      const commonMistakes = prob.mistakes && prob.mistakes.length > 0 
        ? prob.mistakes 
        : ['ËæπÁïåÊù°‰ª∂Â§ÑÁêÜ', 'Á©∫ÂÄº/Á©∫Êï∞ÁªÑÊ£ÄÊü•', 'Á¥¢ÂºïË∂äÁïå', 'ËøîÂõûÂÄºÁ±ªÂûã'];
      exercises.push({
        type: 'recall',
        emoji: '4Ô∏è‚É£',
        title: 'Â∏∏ËßÅÈîôËØØÂõûÂøÜ',
        timeLimit: '60Áßí',
        question: `ÂÜôËøôÈÅìÈ¢òÊó∂ÂÆπÊòìÁäØÂì™‰∫õÈîôËØØÔºüÔºàÊèêÁ§∫ÔºöÊÉ≥ÊÉ≥ËæπÁïåÊù°‰ª∂„ÄÅÁâπÊÆäÊÉÖÂÜµÔºâ`,
        hint: 'ÂõûÂøÜ‰Ω†ÂÅöËøôÈ¢òÊó∂Ë∏©ËøáÁöÑÂùë',
        answer: 'Â∏∏ËßÅÈîôËØØÔºö\n' + commonMistakes.map((m, i) => `${i+1}. ${m}`).join('\n')
      });
      
      // 5. Transfer - Êõ¥ÊøÄËøõÁöÑÂèòÂºèËøΩÈóÆ
      const transferQuestions = [
        {
          question: `Â¶ÇÊûúË¶ÅÊ±Ç O(1) È¢ùÂ§ñÁ©∫Èó¥Ôºå${prob.title} ËØ•ÊÄé‰πàÊîπÔºü`,
          hint: 'ÊÄùËÄÉÔºöËÉΩÂê¶ÂéüÂú∞Êìç‰ΩúÔºüËÉΩÂê¶Áî®‰ΩçËøêÁÆóÔºü'
        },
        {
          question: `Â¶ÇÊûú ${prob.title} ÁöÑËæìÂÖ•ÊòØÊµÅÂºèÊï∞ÊçÆÔºà‰∏ÄÊ¨°Âè™ËÉΩÁúã‰∏Ä‰∏™ÂÖÉÁ¥†ÔºâÔºåÊÄé‰πàÂ§ÑÁêÜÔºü`,
          hint: 'ÊÄùËÄÉÔºöÈúÄË¶ÅÁª¥Êä§‰ªÄ‰πàÁä∂ÊÄÅÔºüËÉΩÂê¶‰∏ÄÈÅçÊâ´ÊèèÔºü'
        },
        {
          question: `Èù¢ËØïÂÆòËøΩÈóÆÔºö‰∏∫‰ªÄ‰πà ${prob.title} ‰∏çÁî®Êö¥ÂäõËß£Ê≥ïÔºü‰ªÄ‰πàÊÉÖÂÜµ‰∏ãÊö¥ÂäõËß£Ê≥ïÊõ¥Â•ΩÔºü`,
          hint: 'ÊÄùËÄÉÔºöÊï∞ÊçÆËßÑÊ®°Â∞èÊó∂Ôºü‰ª£Á†ÅÂèØËØªÊÄßÔºü'
        },
        {
          question: `${prob.title} ÁöÑËß£Ê≥ïËÉΩÂ§ÑÁêÜÊúâÈáçÂ§çÂÖÉÁ¥†ÁöÑÊÉÖÂÜµÂêóÔºüÂ¶ÇÊûú‰∏çËÉΩÔºåÊÄé‰πàÊîπÔºü`,
          hint: 'ÊÄùËÄÉÔºöÈáçÂ§çÂÖÉÁ¥†‰ºöÂΩ±Âìç‰ªÄ‰πàÔºüÈúÄË¶ÅÂéªÈáçÂêóÔºü'
        },
        {
          question: `Â¶ÇÊûú ${prob.title} Ë¶ÅËøîÂõûÊâÄÊúâÂèØËÉΩÁöÑËß£ÔºàËÄå‰∏çÊòØ‰∏Ä‰∏™ÔºâÔºåÂ§çÊùÇÂ∫¶‰ºöÂèòÊàêÂ§öÂ∞ëÔºü`,
          hint: 'ÊÄùËÄÉÔºöËß£ÁöÑÊï∞ÈáèÁ∫ßÊòØÂ§öÂ∞ëÔºüÈúÄË¶ÅÂõûÊ∫ØÂêóÔºü'
        },
        {
          question: `${prob.title} ÂíåÂì™ÈÅìÈ¢òÁöÑÊÄùË∑ØÊúÄÂÉèÔºüËÉΩÂ§çÁî®‰ªÄ‰πàÊ®°ÂºèÔºü`,
          hint: 'ÊÄùËÄÉÔºöÂèåÊåáÈíàÔºüÊªëÂä®Á™óÂè£ÔºüÂâçÁºÄÂíåÔºü'
        },
        {
          question: `Â¶ÇÊûúÈù¢ËØïÂÆòËØ¥"ÂÅáËÆæËæìÂÖ•Â∑≤ÊéíÂ∫è"Ôºå${prob.title} ËÉΩ‰ºòÂåñÂà∞‰ªÄ‰πàÂ§çÊùÇÂ∫¶Ôºü`,
          hint: 'ÊÄùËÄÉÔºöÊéíÂ∫èÂêéËÉΩ‰∫åÂàÜÂêóÔºüËÉΩÂèåÊåáÈíàÂêóÔºü'
        }
      ];
      const randomTransfer = transferQuestions[Math.floor(Math.random() * transferQuestions.length)];
      exercises.push({
        type: 'recall',
        emoji: '5Ô∏è‚É£',
        title: 'ÂèòÂºèËøΩÈóÆ',
        timeLimit: '90Áßí',
        question: randomTransfer.question,
        hint: randomTransfer.hint,
        answer: 'ËøôÊòØÂºÄÊîæÊÄßÈóÆÈ¢òÔºåÂÖ≥ÈîÆÊòØÂ±ïÁ§∫‰Ω†ÁöÑÊÄùËÄÉËøáÁ®ãÂíåÂØπÁÆóÊ≥ïÁöÑÊ∑±ÂÖ•ÁêÜËß£„ÄÇ'
      });
      
      // Build hints
      const hints = [
        { level: 1, label: 'ÁÆóÊ≥ïÊ†áÁ≠æ', content: prob.category.replace(/^\d+-/, '') },
        { level: 2, label: 'È¢òÁõÆÊèèËø∞', content: prob.descSummary || 'ËßÅÁ¨îËÆ∞' },
        { level: 3, label: 'ÂÖ≥ÈîÆË¶ÅÁÇπ', content: prob.keyPoints ? prob.keyPoints.split('\n').slice(0,3).join('\n') : 'ËßÅÁ¨îËÆ∞' }
      ];
      
      return {
        problem: prob.fullTitle,
        number: prob.number,
        difficulty: prob.difficulty,
        category: prob.category,
        hints,
        exercises
      };
    }

    // ---- Quiz ----
    async function startQuiz(num, filterType = null) {
      const quizArea = document.getElementById('quizArea');
      const isQuizOpen = quizArea.classList.contains('open');
      const c = document.getElementById('exContainer');
      const currentCard = c.querySelector('.ex-card');
      
      // If quiz is already open with a card, apply exit animation first
      if (isQuizOpen && currentCard) {
        currentCard.classList.add('card-exit');
        
        // Wait for exit animation, then load new quiz
        await new Promise(resolve => setTimeout(resolve, 300));
      }
      
      // Find problem and generate quiz locally (convert to number for comparison)
      const numInt = typeof num === 'string' ? parseInt(num, 10) : num;
      const prob = problems.find(p => p.number === numInt);
      if (!prob) {
        console.error('Problem not found:', num, '(parsed:', numInt, ')');
        return;
      }
      const fullQuiz = generateQuizFromProblem(prob);
      
      // Filter to single exercise type if specified
      if (filterType) {
        quiz = {
          ...fullQuiz,
          exercises: fullQuiz.exercises.filter(ex => ex.type === filterType)
        };
        
        // If no matching exercise, show error
        if (quiz.exercises.length === 0) {
          console.error(`No exercise of type "${filterType}" found`);
          quiz = fullQuiz; // fallback to full quiz
        }
      } else {
        quiz = fullQuiz;
      }
      
      openQuiz();
    }

    function openQuiz() {
      step = 0;
      answers = {};
      timers = {};
      ratings = {};
      hintLevel = 0;
      document.getElementById('problemSection').classList.remove('open');
      document.getElementById('scoreCard').classList.remove('open');

      // Use fullscreen mode on mobile
      if (window.innerWidth <= 768) {
        openFullscreen();
      } else {
        // Desktop: use inline quiz area
        document.getElementById('quizArea').classList.add('open');
        document.getElementById('quizName').textContent = quiz.problem;

        const diff = document.getElementById('quizDiff');
        diff.textContent = quiz.difficulty;
        diff.className = `tag tag-${quiz.difficulty.toLowerCase()}`;

        document.getElementById('quizCat').textContent = quiz.category.replace(/^\d+-/,'');

        renderStepper();
        renderStepWithEnterAnimation();
        document.getElementById('quizArea').scrollIntoView({ behavior: 'smooth' });
      }
    }

    function closeQuiz() {
      document.getElementById('quizArea').classList.remove('open');
      closeFullscreen();
      stopAllTimers();
      // Refresh stats
      refreshData();
    }

    // ---- Fullscreen Mode ----
    let fsSwipeStartX = 0;
    let fsSwipeStartY = 0;
    let fsSwipeSetup = false;

    function openFullscreen() {
      const fs = document.getElementById('fullscreenQuiz');
      fs.classList.add('open');
      document.body.style.overflow = 'hidden';
      renderFsDots();
      renderFsContent();
      if (!fsSwipeSetup) {
        setupSwipeGestures();
        fsSwipeSetup = true;
      }
    }

    function closeFullscreen() {
      const fs = document.getElementById('fullscreenQuiz');
      fs.classList.remove('open');
      document.body.style.overflow = '';
      stopAllTimers();
      refreshData();
    }

    function renderFsDots() {
      const session = window.currentSession;
      if (!session) return;
      const container = document.getElementById('fsDots');
      container.innerHTML = session.queue.map((item, i) => {
        let cls = 'fs-dot';
        if (i === session.current) cls += ' current';
        else if (item.status === 'completed') cls += ' done';
        return `<div class="${cls}"></div>`;
      }).join('');
    }

    function renderFsContent() {
      const container = document.getElementById('fsContent');
      if (!quiz) {
        container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted);">Ê≤°ÊúâÈ¢òÁõÆ</div>';
        return;
      }
      
      // Render current exercise
      const ex = quiz.exercises[step];
      if (!ex) {
        // Show completion
        renderFsCompletion();
        return;
      }

      container.innerHTML = `
        <div class="fs-title">${quiz.problem}</div>
        <div class="fs-meta">
          <span class="tag tag-${quiz.difficulty.toLowerCase()}">${quiz.difficulty}</span>
          <span class="tag tag-cat">${quiz.category.replace(/^\d+-/,'')}</span>
        </div>
        ${renderExCard(ex, step)}
      `;
      
      // Start timer if needed
      if (ex.timeLimit) startTimer(step, ex.timeLimit);
    }

    function renderFsCompletion() {
      const container = document.getElementById('fsContent');
      const session = window.currentSession;
      const completed = session ? session.queue.filter(q => q.status === 'completed').length : 0;
      
      container.innerHTML = `
        <div style="text-align:center;padding:60px 20px;">
          <div style="font-size:64px;margin-bottom:20px;">üéâ</div>
          <div style="font-size:24px;font-weight:700;margin-bottom:12px;">ÂÆåÊàêÔºÅ</div>
          <div style="color:var(--muted);margin-bottom:30px;">‰ªäÊó•Â∑≤ÂÆåÊàê ${completed} ÈÅìÈ¢ò</div>
        </div>
      `;
      
      // Auto close after 2 seconds
      setTimeout(() => {
        closeFullscreen();
      }, 2000);
    }

    function fsNextQuestion() {
      const session = window.currentSession;
      if (!session) return;
      
      if (session.current >= session.total) {
        renderFsCompletion();
        return;
      }
      
      // Animate and load next
      const content = document.getElementById('fsContent');
      content.classList.add('swipe-left');
      
      setTimeout(() => {
        content.classList.remove('swipe-left');
        smartRecommend();
      }, 300);
    }

    function setupSwipeGestures() {
      const fs = document.getElementById('fullscreenQuiz');
      let startX = 0;
      let startY = 0;
      let startTime = 0;
      
      fs.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        startTime = Date.now();
      }, { passive: true });
      
      fs.addEventListener('touchmove', (e) => {
        // Track for visual feedback if needed
      }, { passive: true });
      
      fs.addEventListener('touchend', (e) => {
        const endX = e.changedTouches[0].clientX;
        const endY = e.changedTouches[0].clientY;
        const deltaX = endX - startX;
        const deltaY = endY - startY;
        const deltaTime = Date.now() - startTime;
        
        // Swipe detection: 
        // - horizontal distance > 50px
        // - more horizontal than vertical
        // - completed within 500ms
        const isHorizontalSwipe = Math.abs(deltaX) > 50 && 
                                   Math.abs(deltaX) > Math.abs(deltaY) * 1.2 &&
                                   deltaTime < 500;
        
        if (isHorizontalSwipe && deltaX < 0) {
          // Swipe left = next question
          console.log('Swipe left detected!');
          fsNextQuestion();
        }
      }, { passive: true });
    }

    // Reset today's session
    function resetTodaySession() {
      if (confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆ‰ªäÊó•ËøõÂ∫¶ÂêóÔºü')) {
        clearSession();
        location.reload();
      }
    }

    async function refreshData() {
      progressData = { progress: loadProgressLocal() };
      reviewData = computeReviewData(progressData.progress);
      renderStats();
      renderProblems();
    }

    // ========== Daily Session Management ==========

    function loadSession() {
      try {
        const json = localStorage.getItem('leetcode-daily-session');
        return json ? JSON.parse(json) : null;
      } catch (e) {
        console.error('Failed to load session:', e);
        return null;
      }
    }

    function saveSession(session) {
      try {
        localStorage.setItem('leetcode-daily-session', JSON.stringify(session));
      } catch (e) {
        console.error('Failed to save session:', e);
      }
    }

    function clearSession() {
      localStorage.removeItem('leetcode-daily-session');
    }

    function generateDailyQueue(progressData, targetCount = 10) {
      const today = getTodayStr();
      const allItems = [];
      const newProblems = []; // Track problems never practiced
      
      // Build problem ID -> category mapping
      const idToCategory = {};
      const idToNumber = {};
      const allProblemIds = new Set();
      problems.forEach(p => {
        const paddedId = String(p.number).padStart(3, '0');
        idToCategory[paddedId] = p.category;
        idToNumber[paddedId] = p.number;
        allProblemIds.add(paddedId);
      });
      
      // Collect all problem-type pairs with progress
      const practicedIds = new Set();
      for (const [id, problemData] of Object.entries(progressData)) {
        practicedIds.add(id);
        for (const [type, typeData] of Object.entries(problemData)) {
          if (!typeData.nextReview) continue; // Skip uninitialized
          
          allItems.push({
            id,
            type,
            ease: typeData.ease,
            nextReview: typeData.nextReview,
            isDue: typeData.nextReview <= today,
            category: idToCategory[id] || 'unknown',
            isNew: false
          });
        }
      }
      
      // Add new problems (never practiced)
      const exerciseTypes = ['recall', 'fill', 'choice', 'bug', 'transfer'];
      for (const problemId of allProblemIds) {
        if (!practicedIds.has(problemId)) {
          // Add all 5 exercise types for this new problem
          for (const type of exerciseTypes) {
            newProblems.push({
              id: problemId,
              type,
              ease: 2.5, // default ease
              nextReview: today, // due today
              isDue: true,
              category: idToCategory[problemId] || 'unknown',
              isNew: true
            });
          }
        }
      }
      
      // Prioritize new problems first (up to 50% of target)
      const newSlots = Math.min(newProblems.length, Math.ceil(targetCount * 0.5));
      const selected = [];
      
      if (newProblems.length > 0) {
        // Shuffle and take first N new items
        const shuffledNew = newProblems.sort(() => Math.random() - 0.5);
        selected.push(...shuffledNew.slice(0, newSlots));
      }
      
      // Fill remaining slots with practiced items (category-balanced)
      const remainingSlots = targetCount - selected.length;
      if (remainingSlots > 0 && allItems.length > 0) {
        // Group by category
        const byCategory = {};
        for (const item of allItems) {
          if (!byCategory[item.category]) {
            byCategory[item.category] = [];
          }
          byCategory[item.category].push(item);
        }
        
        // Select one item from each category (prioritize due items, then by ease)
        const categories = Object.keys(byCategory).sort(() => Math.random() - 0.5);
        
        for (const cat of categories) {
          if (selected.length >= targetCount) break;
          
          const items = byCategory[cat];
          // Sort: due first, then by ease (lower = weaker = priority)
          items.sort((a, b) => {
            if (a.isDue !== b.isDue) return b.isDue ? 1 : -1;
            return a.ease - b.ease;
          });
          
          if (items.length > 0) {
            selected.push(items[0]);
          }
        }
        
        // If still under target, fill with remaining items
        if (selected.length < targetCount) {
          const selectedIds = new Set(selected.map(s => `${s.id}-${s.type}`));
          const remaining = allItems
            .filter(item => !selectedIds.has(`${item.id}-${item.type}`))
            .sort((a, b) => {
              if (a.isDue !== b.isDue) return b.isDue ? 1 : -1;
              return a.ease - b.ease;
            });
          
          selected.push(...remaining.slice(0, targetCount - selected.length));
        }
      }
      
      // Interleaving: ‰∫§ÈîôÊéíÂàóÔºåÁ°Æ‰øùÁõ∏ÈÇªÈ¢òÁõÆ category ‰∏çÂêå
      const interleaved = [];
      const remaining = [...selected];
      
      while (remaining.length > 0) {
        if (interleaved.length === 0) {
          // First item: pick randomly
          const idx = Math.floor(Math.random() * remaining.length);
          interleaved.push(remaining.splice(idx, 1)[0]);
        } else {
          // Find an item with different category than the last one
          const lastCat = interleaved[interleaved.length - 1].category;
          const diffCatIdx = remaining.findIndex(item => item.category !== lastCat);
          
          if (diffCatIdx !== -1) {
            // Found different category - use it
            interleaved.push(remaining.splice(diffCatIdx, 1)[0]);
          } else {
            // All remaining are same category - just pick randomly
            const idx = Math.floor(Math.random() * remaining.length);
            interleaved.push(remaining.splice(idx, 1)[0]);
          }
        }
      }
      
      // Replace selected with interleaved
      selected.length = 0;
      selected.push(...interleaved);
      
      // Handle empty result
      if (selected.length === 0) {
        return {
          date: today,
          queue: [],
          current: 0,
          total: 0
        };
      }
      
      // Convert to queue format
      return {
        date: today,
        queue: selected.map(item => ({
          id: item.id,
          type: item.type,
          status: 'pending'
        })),
        current: 0,
        total: selected.length
      };
    }

    async function initDailySession(progressData) {
      let session = loadSession();
      const today = getTodayStr();
      
      console.log('[DEBUG] initDailySession called');
      console.log('[DEBUG] loadSession result:', session);
      console.log('[DEBUG] today:', today);
      console.log('[DEBUG] problems.length at init:', problems.length);
      
      // ALWAYS regenerate if queue is empty or no problems loaded yet
      const needsRegen = !session || 
                         session.date !== today || 
                         !session.queue || 
                         session.queue.length === 0 ||
                         session.total === 0;
      
      if (needsRegen) {
        console.log('[DEBUG] Need to generate new session');
        // Clear stale session first
        clearSession();
        // Generate new daily session
        session = generateDailyQueue(progressData);
        saveSession(session);
      } else {
        // Resume existing session
      }
      
      return session;
    }

    function renderStepper() {
      document.getElementById('stepper').innerHTML = quiz.exercises.map((_, i) =>
        `<div class="step ${i === step ? 'active' : ''} ${answers[i] !== undefined ? 'done' : ''}" onclick="goStep(${i})"></div>`
      ).join('');
    }

    function goStep(i) {
      const c = document.getElementById('exContainer');
      const currentCard = c.querySelector('.ex-card');
      
      // Apply exit animation if card exists
      if (currentCard) {
        currentCard.classList.add('card-exit');
        
        // Wait for animation to complete
        setTimeout(() => {
          stopTimer(step);
          step = i;
          hintLevel = 0; // reset hints per exercise
          renderStepper();
          renderStepWithEnterAnimation();
        }, 300);
      } else {
        // No current card, render immediately
        stopTimer(step);
        step = i;
        hintLevel = 0;
        renderStepper();
        renderStep();
      }
    }

    function renderStep() {
      const ex = quiz.exercises[step];
      const c = document.getElementById('exContainer');
      c.innerHTML = renderExCard(ex, step);
      startTimer(step, ex.timeLimit);
      renderNav();
    }

    function renderStepWithEnterAnimation() {
      const ex = quiz.exercises[step];
      const c = document.getElementById('exContainer');
      c.innerHTML = renderExCard(ex, step);
      
      // Apply enter animation
      const newCard = c.querySelector('.ex-card');
      if (newCard) {
        newCard.classList.add('card-enter');
        
        // Remove animation class after completion
        setTimeout(() => {
          newCard.classList.remove('card-enter');
        }, 300);
      }
      
      startTimer(step, ex.timeLimit);
      renderNav();
    }

    function renderExCard(ex, idx) {
      const iconMap = {
        recall: ['üéØ', 'recall'],
        fill: ['‚úèÔ∏è', 'fill'],
        choice: ['‚ö°', 'choice'],
        bug: ['üêõ', 'bug'],
        transfer: ['üîÄ', 'transfer']
      };
      const [icon, cls] = iconMap[ex.type] || ['üìù', 'recall'];

      let body = '';

      // Hint button (shown for all exercise types)
      const hintBtnHtml = quiz.hints && quiz.hints.length > 0
        ? `<button class="hint-btn" onclick="revealHint(${idx})">üí° ÊèêÁ§∫ <span class="hint-badge">${hintLevel}/3</span></button>
           <div class="hint-area" id="hintArea-${idx}"></div>`
        : '';

      switch (ex.type) {
        case 'recall':
          const descHtml = ex.description
            ? `<div class="problem-desc">${formatMd(ex.description)}</div>`
            : '';
          body = `
            ${hintBtnHtml}
            ${descHtml}
            <div class="ex-question">${esc(ex.question)}</div>
            <div id="recallInput-${idx}">
              <textarea class="input-area" id="recallText-${idx}" placeholder="ÊèèËø∞‰Ω†ÁöÑËß£È¢òÊÄùË∑Ø...‰∏çË¶ÅÁøªÁ¨îËÆ∞ÔºÅ&#10;&#10;ÊèêÁ§∫ÔºöÁî®‰ªÄ‰πàÁÆóÊ≥ïÔºü‰∏∫‰ªÄ‰πàÈÄâËøô‰∏™ÊñπÊ≥ïÔºüÂÖ≥ÈîÆÊ≠•È™§ÊòØ‰ªÄ‰πàÔºü" rows="6"></textarea>
              <button class="submit-btn" onclick="submitRecall(${idx})">üìù Êèê‰∫§ÊÄùË∑Ø</button>
            </div>
            <div class="flip-container" id="recallFlipContainer-${idx}" style="display:none">
              <div class="flip-card" id="recallFlipCard-${idx}">
                <div class="flip-front"></div>
                <div class="flip-back">
                  <div id="recallResult-${idx}"></div>
                </div>
              </div>
            </div>
            <div id="rateArea-${idx}"></div>
          `;
          break;

        case 'fill':
          let fillBodyHtml = '';
          if (ex.lines && ex.lines.length > 0) {
            // New inline blank mode
            const codeHtml = ex.lines.map((line, li) => {
              if (line.type === 'blank') {
                return `<div class="blank-row">${esc(line.indent)}<input type="text" class="blank-input" id="blank-${idx}-${line.blankIndex}" data-blank-idx="${line.blankIndex}" placeholder="Â°´ÂÜô‰ª£Á†Å..." autocomplete="off" spellcheck="false"></div>`;
              } else {
                return `<div class="code-line">${highlightPython(line.content)}</div>`;
              }
            }).join('\n');

            fillBodyHtml = `
              ${hintBtnHtml}
              <div class="ex-question">${esc(ex.question)}</div>
              <div class="code-block-fill" id="fillCode-${idx}">${codeHtml}</div>
              <button class="submit-btn" id="fillSubmitBtn-${idx}" onclick="submitInlineFill(${idx})">üîç Ê£ÄÊü•‰ª£Á†Å</button>
              <div class="flip-container" id="fillFlipContainer-${idx}" style="display:none">
                <div class="flip-card" id="fillFlipCard-${idx}">
                  <div class="flip-front"></div>
                  <div class="flip-back">
                    <div id="fillResult-${idx}"></div>
                  </div>
                </div>
              </div>
              <div id="rateArea-${idx}"></div>
            `;
          } else {
            // Fallback: old textarea mode
            fillBodyHtml = `
              ${hintBtnHtml}
              <div class="ex-question">Ë°•ÂÖ®‰∏ãÈù¢‰ª£Á†ÅÁöÑÂÖ≥ÈîÆÈÄªËæëÔºö</div>
              <div id="fillInput-${idx}">
                <textarea class="input-area code-input" id="fillText-${idx}" placeholder="Âú®ËøôÈáåË°•ÂÖ®‰ª£Á†Å..."></textarea>
                <button class="submit-btn" onclick="submitFill(${idx})">üîç Ê£ÄÊü•‰ª£Á†Å</button>
              </div>
              <div class="flip-container" id="fillFlipContainer-${idx}" style="display:none">
                <div class="flip-card" id="fillFlipCard-${idx}">
                  <div class="flip-front"></div>
                  <div class="flip-back">
                    <div id="fillResult-${idx}"></div>
                  </div>
                </div>
              </div>
              <div id="rateArea-${idx}"></div>
            `;
          }
          body = fillBodyHtml;
          break;

        case 'choice':
          const letters = ['A', 'B', 'C', 'D'];
          body = `
            ${hintBtnHtml}
            <div class="ex-question">${esc(ex.question)}</div>
            <div class="opts" id="opts-${idx}">
              ${ex.options.map((o, i) => `
                <div class="opt" id="opt-${idx}-${i}" onclick="pick(${idx},${i},${ex.correctIndex})">
                  <div class="opt-letter">${letters[i]}</div>
                  <span>${esc(o)}</span>
                </div>
              `).join('')}
            </div>
            <div id="rateArea-${idx}"></div>
          `;
          break;

        case 'bug':
          let bugCodeHtml = '';
          if (ex.lines && ex.lines.length > 0) {
            bugCodeHtml = `<div class="bug-code-block" id="bugCode-${idx}">` +
              ex.lines.map((line, li) => {
                return `<div class="bug-line" id="bugLine-${idx}-${li}" onclick="selectBugLine(${idx}, ${li})">${highlightPython(line)}</div>`;
              }).join('\n') +
              '</div>';
          } else {
            bugCodeHtml = ex.bugCode ? `<div>${formatCode(ex.bugCode, false)}</div>` : '';
          }
          body = `
            ${hintBtnHtml}
            <div class="ex-question">${esc(ex.question)}</div>
            ${bugCodeHtml}
            <div id="bugResult-${idx}" style="display:none"></div>
            <div class="flip-container" id="bugFlipContainer-${idx}" style="display:none">
              <div class="flip-card" id="bugFlipCard-${idx}">
                <div class="flip-front">
                  <button class="reveal" id="revealBtn-${idx}" onclick="flipBugReveal(${idx})">üëÅ Êü•Áúã Bug Ëß£Êûê</button>
                </div>
                <div class="flip-back">
                  <div class="answer">
                    <div class="answer-label">üêõ Bug ÂàÜÊûê</div>
                    <div style="color:var(--text2)">
                      <strong>Bug ‰ΩçÁΩÆÔºö</strong>Á¨¨ ${(ex.bugLineIndex || 0) + 1} Ë°å<br>
                      <strong>ÈóÆÈ¢òÔºö</strong>${esc(ex.bugDescription || '‰ª£Á†ÅÈÄªËæëÊúâËØØ')}<br><br>
                      <strong>Ê≠£Á°Æ‰ª£Á†ÅÔºö</strong>
                      <pre style="margin-top:8px;padding:12px;background:var(--surface3);border-radius:6px;overflow-x:auto"><code>${esc(ex.correctCode || '')}</code></pre>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div id="rateArea-${idx}"></div>
          `;
          break;

        case 'transfer':
          body = `
            ${hintBtnHtml}
            <div class="ex-question">${esc(ex.question)}</div>
            ${ex.options ? `
              <div class="opts" id="opts-${idx}">
                ${['A','B','C','D'].slice(0,ex.options.length).map((l,i) => `
                  <div class="opt" id="opt-${idx}-${i}" onclick="pick(${idx},${i},${ex.correctIndex})">
                    <div class="opt-letter">${l}</div>
                    <span>${esc(ex.options[i])}</span>
                  </div>
                `).join('')}
              </div>
            ` : ''}
            <div class="flip-container">
              <div class="flip-card" id="flipCard-${idx}">
                <div class="flip-front">
                  <button class="reveal" id="revealBtn-${idx}" onclick="flipReveal(${idx})">üëÅ Êü•ÁúãËß£Êûê</button>
                </div>
                <div class="flip-back">
                  <div class="answer">
                    <div class="answer-label">üí° Ëß£Êûê</div>
                    <p style="color:var(--text2)">${esc(ex.answer)}</p>
                  </div>
                </div>
              </div>
            </div>
            <div id="rateArea-${idx}"></div>
          `;
          break;
      }

      return `
        <div class="ex-card">
          <div class="ex-top">
            <div class="ex-type">
              <div class="ex-type-icon ${cls}">${icon}</div>
              ${ex.title}
            </div>
            <div class="ex-timer" id="timer-${idx}">
              <div class="timer-dot" id="tdot-${idx}"></div>
              <span id="tval-${idx}">0:00</span>
            </div>
          </div>
          <div class="ex-body">${body}</div>
        </div>
      `;
    }

    function renderNav() {
      const total = quiz.exercises.length;
      document.getElementById('navRow').innerHTML = `
        <button class="btn btn-sm btn-ghost" ${step === 0 ? 'disabled style="opacity:.3;pointer-events:none"' : ''} onclick="goStep(${step-1})">‚Üê ‰∏ä‰∏ÄÈ¢ò</button>
        <span style="color:var(--muted);font-size:13px;font-family:var(--mono)">${step+1} / ${total}</span>
        ${step < total - 1
          ? `<button class="btn btn-sm btn-primary" onclick="goStep(${step+1})">‰∏ã‰∏ÄÈ¢ò ‚Üí</button>`
          : `<button class="btn btn-sm" style="background:var(--green2);border-color:var(--green2);color:white" onclick="showScore()">ÂÆåÊàê ‚úì</button>`
        }
      `;
    }

    // ---- Progressive Hints ----
    function revealHint(idx) {
      if (!quiz.hints || hintLevel >= 3) return;
      hintLevel++;

      const area = document.getElementById(`hintArea-${idx}`);
      if (!area) return;

      const hint = quiz.hints[hintLevel - 1];
      if (!hint) return;

      // Append new hint layer
      const layer = document.createElement('div');
      layer.className = 'hint-layer';
      layer.innerHTML = `
        <div>
          <div class="hint-level-label">Level ${hint.level} ‚Äî ${esc(hint.label)}</div>
          <div class="hint-content">${esc(hint.content)}</div>
        </div>
      `;
      area.appendChild(layer);

      // Update badge
      const badge = area.parentElement.querySelector('.hint-badge');
      if (badge) badge.textContent = `${hintLevel}/3`;

      // If used 3 hints, show suggestion
      if (hintLevel >= 3) {
        const suggestion = document.createElement('div');
        suggestion.className = 'rate-suggestion';
        suggestion.textContent = 'üí° ‰Ω†‰ΩøÁî®‰∫Ü 3 Á∫ßÊèêÁ§∫ÔºåÂª∫ËÆÆËá™ËØÑÊó∂ÈÄâÊã©„ÄåÈÉ®ÂàÜÂõûÂøÜ„Äç';
        area.appendChild(suggestion);
      }
    }

    // ---- Recall: Submit & Compare ----
    function submitRecall(idx) {
      const textarea = document.getElementById(`recallText-${idx}`);
      if (!textarea) return;
      const userAnswer = textarea.value.trim();
      if (!userAnswer) return;

      const ex = quiz.exercises[idx];

      // Hide input
      document.getElementById(`recallInput-${idx}`).style.display = 'none';

      // Show answer overlay with structured content
      const content = `
        <div class="answer-section" style="border-left-color: var(--blue);">
          <div class="answer-section-title" style="color: var(--blue);">üìù ‰Ω†ÁöÑÂõûÁ≠î</div>
          <div class="answer-section-content">${esc(userAnswer).replace(/\n/g, '<br>')}</div>
        </div>
        <div style="margin-top: 16px;">
          <div class="answer-section-title" style="color: var(--green); margin-bottom: 12px;">‚úÖ ÂèÇËÄÉÊÄùË∑Ø</div>
          ${formatAnswerStructured(ex.answer)}
        </div>
      `;
      showAnswerOverlay('üéØ ÂØπÊØîÁªìÊûú', content);

      answers[idx] = true;
      stopTimer(idx);
      renderStepper();

      // Show self-rating
      showRating(idx, 'recall');
    }

    // ---- Fill: Submit & Diff ----
    function submitFill(idx) {
      const textarea = document.getElementById(`fillText-${idx}`);
      if (!textarea) return;
      const userCode = textarea.value;
      const ex = quiz.exercises[idx];

      // Get reference code
      const refCode = ex.fullCode || '';

      // Hide input
      document.getElementById(`fillInput-${idx}`).style.display = 'none';

      // Show answer overlay
      showAnswerOverlay('‚úèÔ∏è ‰ª£Á†ÅÂØπÊØî', generateDiffHtml(userCode, refCode));

      answers[idx] = true;
      stopTimer(idx);
      renderStepper();

      // Show self-rating
      showRating(idx, 'fill');
    }

    function generateDiffHtml(userCode, refCode) {
      const userLines = userCode.split('\n');
      const refLines = refCode.split('\n');
      const maxLen = Math.max(userLines.length, refLines.length);

      let diffHtml = '';
      for (let i = 0; i < maxLen; i++) {
        const uLine = i < userLines.length ? userLines[i] : '';
        const rLine = i < refLines.length ? refLines[i] : '';

        if (uLine.trim() === rLine.trim()) {
          diffHtml += `<div class="diff-line same">${esc(rLine) || '&nbsp;'}</div>`;
        } else if (!uLine.trim() && rLine.trim()) {
          // User missed this line
          diffHtml += `<div class="diff-line added">+ ${esc(rLine)}</div>`;
        } else if (uLine.trim() && !rLine.trim()) {
          // User added extra line
          diffHtml += `<div class="diff-line removed">- ${esc(uLine)}</div>`;
        } else {
          // Different content
          diffHtml += `<div class="diff-line removed">- ${esc(uLine)}</div>`;
          diffHtml += `<div class="diff-line added">+ ${esc(rLine)}</div>`;
        }
      }

      return `
        <div class="diff-view">
          <div class="diff-label">‰ª£Á†ÅÂØπÊØî</div>
          <div class="diff-container">${diffHtml}</div>
          <div class="diff-legend">
            <span><span class="diff-dot g"></span> ÂèÇËÄÉ‰ª£Á†Å</span>
            <span><span class="diff-dot r"></span> ‰Ω†ÁöÑ‰ª£Á†ÅÔºàÂ∑ÆÂºÇÔºâ</span>
          </div>
        </div>
      `;
    }

    // ---- Self Rating ----
    function showRating(idx, exerciseType) {
      const rateArea = document.getElementById(`rateArea-${idx}`);
      if (!rateArea) return;

      const suggestPartial = hintLevel >= 3;

      rateArea.innerHTML = `
        <div class="self-rating" id="selfRate-${idx}">
          <button class="rate-btn good" onclick="submitRating(${idx}, 'good', '${exerciseType}')">‚úÖ ÂÆåÂÖ®ÂõûÂøÜ</button>
          <button class="rate-btn partial" onclick="submitRating(${idx}, 'partial', '${exerciseType}')">üü° ÈÉ®ÂàÜÂõûÂøÜ</button>
          <button class="rate-btn forgot" onclick="submitRating(${idx}, 'forgot', '${exerciseType}')">‚ùå Âøò‰∫Ü</button>
        </div>
        ${suggestPartial ? '<div class="rate-suggestion">üí° ‰Ω†‰ΩøÁî®‰∫Ü 3 Á∫ßÊèêÁ§∫ÔºåÂª∫ËÆÆÈÄâÊã©„Äåüü° ÈÉ®ÂàÜÂõûÂøÜ„Äç</div>' : ''}
      `;
    }

    async function submitRating(idx, rating, exerciseType) {
      if (ratings[idx]) return; // already rated
      
      // Check if we've crossed into a new day
      const session = window.currentSession;
      const today = getTodayStr();
      if (session && session.date !== today) {
        if (confirm('Êñ∞ÁöÑ‰∏ÄÂ§©ÂºÄÂßã‰∫ÜÔºÅË¶ÅÂºÄÂßãÊñ∞ÁöÑ 10 È¢òÂêóÔºü')) {
          clearSession();
          location.reload();
        }
        return;
      }
      
      ratings[idx] = rating;

      // Highlight selected button
      const btns = document.querySelectorAll(`#selfRate-${idx} .rate-btn`);
      btns.forEach(b => {
        if (b.classList.contains(rating)) {
          b.classList.add('selected');
        } else {
          b.classList.add('selected');
          b.style.opacity = '0.3';
        }
      });

      // Save to localStorage (SM-2 algorithm)
      const number = String(quiz.number).padStart(3, '0');
      const progress = loadProgressLocal();
      if (!progress[number]) progress[number] = {};
      if (!progress[number][exerciseType]) {
        progress[number][exerciseType] = { ease: 2.5, interval: 1, nextReview: getTodayStr(), history: [] };
      }
      
      const entry = progress[number][exerciseType];
      if (rating === 'good') {
        entry.interval = Math.round(entry.interval * entry.ease);
        entry.ease = Math.max(1.3, entry.ease + 0.1);
      } else if (rating === 'partial') {
        entry.interval = Math.round(entry.interval * 1.2);
        entry.ease = Math.max(1.3, entry.ease - 0.15);
      } else {
        entry.interval = 1;
        entry.ease = Math.max(1.3, entry.ease - 0.3);
      }
      
      const nextDate = new Date();
      nextDate.setDate(nextDate.getDate() + entry.interval);
      entry.nextReview = nextDate.toISOString().slice(0, 10);
      entry.history.push({ date: getTodayStr(), rating, interval: entry.interval });
      
      saveProgressLocal(progress);
      const data = { nextReview: entry.nextReview, interval: entry.interval, ease: entry.ease };

      // Show result
      const rateArea = document.getElementById(`rateArea-${idx}`);
      const resultDiv = document.createElement('div');
      resultDiv.className = 'rate-result';
      const nextDateStr = data.nextReview || '?';
      const interval = data.interval || '?';
      resultDiv.innerHTML = `üìÖ ‰∏ãÊ¨°Â§ç‰π†Ôºö${nextDateStr}ÔºàÈó¥Èöî ${interval} Â§©Ôºâ | ÈöæÂ∫¶Á≥ªÊï∞Ôºö${(data.ease || 0).toFixed(2)}`;
      rateArea.appendChild(resultDiv);

      // Update session progress (reuse session from above)
      if (session && session.current < session.total) {
        // Mark current item as completed
        session.queue[session.current].status = 'completed';
        session.queue[session.current].rating = rating;
        session.current++;
        
        // Save session
        saveSession(session);
        
        // Refresh stats display
        renderStats();
        
        // Auto-advance to next card or show summary
        setTimeout(() => {
          // Update fullscreen dots if in fullscreen mode
          if (document.getElementById('fullscreenQuiz').classList.contains('open')) {
            renderFsDots();
          }
          
          if (session.current < session.total) {
            smartRecommend();
          } else {
            // Check if in fullscreen mode
            if (document.getElementById('fullscreenQuiz').classList.contains('open')) {
              renderFsCompletion();
            } else {
              showSessionSummary();
            }
          }
        }, 500);
      }
    }

    // ---- Choice / Option Pick ----
    function pick(idx, optIdx, correctIdx) {
      if (answers[idx] !== undefined) return;
      answers[idx] = optIdx === correctIdx;
      stopTimer(idx);

      const opts = document.querySelectorAll(`#opts-${idx} .opt`);
      opts.forEach(o => o.classList.add('disabled'));

      document.getElementById(`opt-${idx}-${optIdx}`).classList.add(optIdx === correctIdx ? 'correct' : 'wrong');
      if (optIdx !== correctIdx) {
        document.getElementById(`opt-${idx}-${correctIdx}`).classList.add('correct');
      }

      renderStepper();

      // Show self-rating for choice/bug/transfer
      const ex = quiz.exercises[idx];
      showRating(idx, ex.type);
    }

    function reveal(idx) {
      const el = document.getElementById(`ans-${idx}`);
      el.classList.toggle('open');
      if (el.classList.contains('open') && answers[idx] === undefined) {
        answers[idx] = true;
        stopTimer(idx);
        renderStepper();

        // Show self-rating
        const ex = quiz.exercises[idx];
        showRating(idx, ex.type);
      }
    }

    function flipReveal(idx) {
      const ex = quiz.exercises[idx];
      if (!ex) return;
      
      // Show answer in overlay with structured format
      showAnswerOverlay('üí° Ëß£Êûê', formatAnswerStructured(ex.answer));
      
      if (answers[idx] === undefined) {
        answers[idx] = true;
        stopTimer(idx);
        renderStepper();

        // Show self-rating
        showRating(idx, ex.type);
      }
    }

    function selectBugLine(idx, lineIdx) {
      if (answers[idx] !== undefined) return; // Already answered

      const ex = quiz.exercises[idx];
      const correctLineIdx = ex.bugLineIndex;
      const isCorrect = lineIdx === correctLineIdx;

      // Mark answer
      answers[idx] = isCorrect;
      stopTimer(idx);

      // Disable all lines
      const allLines = document.querySelectorAll(`#bugCode-${idx} .bug-line`);
      allLines.forEach(line => line.classList.add('disabled'));

      // Highlight selected line
      const selectedLine = document.getElementById(`bugLine-${idx}-${lineIdx}`);
      if (isCorrect) {
        selectedLine.classList.add('correct');
      } else {
        selectedLine.classList.add('wrong');
        // Highlight correct line
        const correctLine = document.getElementById(`bugLine-${idx}-${correctLineIdx}`);
        if (correctLine) correctLine.classList.add('correct');
      }

      // Show result
      const resultDiv = document.getElementById(`bugResult-${idx}`);
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = isCorrect 
        ? `<div style="color:var(--green);padding:12px;background:var(--green-soft);border-radius:8px;margin-top:12px">‚úÖ Ê≠£Á°ÆÔºÅ‰Ω†ÊâæÂà∞‰∫Ü bug</div>`
        : `<div style="color:var(--red);padding:12px;background:var(--red-soft);border-radius:8px;margin-top:12px">‚ùå ‰∏çÂØπÔºåbug Âú®Á¨¨ ${correctLineIdx + 1} Ë°å</div>`;

      // Show flip container with reveal button
      const flipContainer = document.getElementById(`bugFlipContainer-${idx}`);
      if (flipContainer) flipContainer.style.display = 'block';

      renderStepper();

      // Show self-rating
      showRating(idx, 'bug');
    }

    function flipBugReveal(idx) {
      const ex = quiz.exercises[idx];
      if (!ex) return;
      
      const content = `
        <div style="color:var(--text2);line-height:1.8">
          <strong>Bug ‰ΩçÁΩÆÔºö</strong>Á¨¨ ${(ex.bugLineIndex || 0) + 1} Ë°å<br><br>
          <strong>ÈóÆÈ¢òÔºö</strong>${esc(ex.bugDescription || '‰ª£Á†ÅÈÄªËæëÊúâËØØ')}<br><br>
          <strong>Ê≠£Á°Æ‰ª£Á†ÅÔºö</strong>
          <pre style="margin-top:8px;padding:12px;background:var(--surface3);border-radius:6px;overflow-x:auto"><code>${esc(ex.correctCode || '')}</code></pre>
        </div>
      `;
      showAnswerOverlay('üêõ Bug ÂàÜÊûê', content);
    }

    function revealBug(idx) {
      // Legacy function - kept for compatibility
      const el = document.getElementById(`ans-${idx}`);
      if (el) el.classList.toggle('open');
    }

    function showScore() {
      stopAllTimers();
      const total = quiz.exercises.length;
      const rated = Object.keys(ratings).length;
      const goodCount = Object.values(ratings).filter(r => r === 'good').length;
      const partialCount = Object.values(ratings).filter(r => r === 'partial').length;
      const forgotCount = Object.values(ratings).filter(r => r === 'forgot').length;

      const pct = rated > 0 ? Math.round(goodCount / rated * 100) : 0;
      const emoji = pct >= 80 ? 'üéâ' : pct >= 60 ? 'üí™' : pct >= 40 ? 'ü§î' : 'üìö';
      const text = pct >= 80 ? 'ÊéåÊè°ÂæóÂæàÂ•ΩÔºÅ' : pct >= 60 ? '‰∏çÈîôÔºåÁªßÁª≠‰øùÊåÅ' : pct >= 40 ? 'ËøòÈúÄÂä†Âº∫ÔºÅ' : 'Â§öÂ§ç‰π†Âá†Ê¨°Âêß';

      const sc = document.getElementById('scoreCard');
      sc.innerHTML = `
        <div class="score-emoji">${emoji}</div>
        <div class="score-text">${text}</div>
        <div class="score-sub">${quiz.problem}</div>
        <div class="score-nums">
          <div class="score-n"><div class="big" style="color:var(--green)">${goodCount}</div><div class="lbl">ÂÆåÂÖ®ÂõûÂøÜ</div></div>
          <div class="score-n"><div class="big" style="color:var(--orange)">${partialCount}</div><div class="lbl">ÈÉ®ÂàÜÂõûÂøÜ</div></div>
          <div class="score-n"><div class="big" style="color:var(--red)">${forgotCount}</div><div class="lbl">Âøò‰∫Ü</div></div>
        </div>
        <div class="btn-row">
          <button class="btn btn-primary" onclick="smartRecommend()">‚≠ê ‰∏ã‰∏ÄÁªÑ</button>
          <button class="btn btn-ghost" onclick="closeQuiz()">ËøîÂõûÈ¶ñÈ°µ</button>
        </div>
      `;
      sc.classList.add('open');
      sc.scrollIntoView({ behavior: 'smooth' });
    }

    // ---- Timer ----
    function startTimer(idx, limit) {
      const tval = document.getElementById(`tval-${idx}`);
      const tdot = document.getElementById(`tdot-${idx}`);
      if (!tval) return;

      let sec = 0;
      timers[idx] = setInterval(() => {
        sec++;
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        tval.textContent = `${m}:${String(s).padStart(2, '0')}`;
      }, 1000);
    }

    function stopTimer(idx) {
      if (timers[idx]) {
        clearInterval(timers[idx]);
        delete timers[idx];
      }
      const dot = document.getElementById(`tdot-${idx}`);
      if (dot) dot.classList.add('stopped');
    }

    function stopAllTimers() {
      Object.keys(timers).forEach(k => {
        clearInterval(timers[k]);
        delete timers[k];
      });
    }

    // ---- Formatting ----
    function esc(s) {
      if (!s) return '';
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function highlightPython(line) {
      let escaped = esc(line);
      if (line.trim().startsWith('#')) {
        return `<span class="cmt">${escaped}</span>`;
      }
      escaped = escaped.replace(/\b(def|if|else|elif|while|for|in|return|import|from|and|or|not|True|False|None|class|try|except|with|as|lambda|yield|break|continue|pass|del|raise|finally|global|nonlocal|assert)\b/g, '<span class="kw">$1</span>');
      escaped = escaped.replace(/\b(\d+)\b/g, '<span class="num">$1</span>');
      escaped = escaped.replace(/(&#39;[^&#]*&#39;|&quot;[^&]*&quot;)/g, '<span class="str">$1</span>');
      return escaped;
    }

    function submitInlineFill(idx) {
      const ex = quiz.exercises[idx];
      if (!ex.blanks || answers[idx] !== undefined) return;

      let allCorrect = true;
      ex.blanks.forEach(blank => {
        const input = document.getElementById(`blank-${idx}-${blank.index}`);
        if (!input) return;

        const userVal = input.value.trim();
        const expected = blank.answer.trim();

        // Flexible comparison: normalize whitespace
        const normalize = s => s.replace(/\s+/g, ' ').trim();
        const isCorrect = normalize(userVal) === normalize(expected);

        input.classList.add(isCorrect ? 'correct' : 'wrong');
        input.readOnly = true;

        if (!isCorrect) {
          allCorrect = false;
          // Show correct answer below
          const answerEl = document.createElement('div');
          answerEl.className = 'blank-answer show';
          answerEl.textContent = `‚úÖ ${expected}`;
          input.parentElement.appendChild(answerEl);
        }
      });

      answers[idx] = allCorrect;
      stopTimer(idx);
      renderStepper();

      // Hide submit button
      const btn = document.getElementById(`fillSubmitBtn-${idx}`);
      if (btn) btn.style.display = 'none';

      // Show self-rating
      showRating(idx, 'fill');
    }

    function formatCode(text, highlight) {
      let code = text;
      const m = text.match(/```(?:python)?\n([\s\S]*?)```/);
      if (m) code = m[1];
      code = code.replace(/```\w*\n?/g, '');

      let lines = code.split('\n');
      lines = lines.map(line => {
        const trimmed = line.trim();

        if (highlight && /_{3,}/.test(line)) {
          const indent = line.match(/^(\s*)/)[1];
          const suffix = line.match(/#\s*Â°´Á©∫\d*/);
          return `${esc(indent)}<span class="blank">_____ ${suffix ? suffix[0] : ''}</span>`;
        }

        if (/üêõ/.test(line)) {
          const parts = line.split(/#\s*üêõ/);
          return esc(parts[0]) + `<span style="color:var(--red)"># üêõ${esc(parts[1] || '')}</span>`;
        }

        if (trimmed.startsWith('#')) {
          return `<span class="cmt">${esc(line)}</span>`;
        }

        if (trimmed.startsWith('"""') || trimmed.startsWith("'''")) {
          return `<span class="str">${esc(line)}</span>`;
        }

        let escaped = esc(line);
        escaped = escaped.replace(/\b(def|if|else|elif|while|for|in|return|import|from|and|or|not|True|False|None|class|try|except|with|as|lambda|yield|break|continue|pass|del|raise|finally|global|nonlocal|assert)\b/g, '<span class="kw">$1</span>');
        escaped = escaped.replace(/\b(\d+)\b/g, '<span class="num">$1</span>');
        escaped = escaped.replace(/(&#39;[^&#]*&#39;|&quot;[^&]*&quot;)/g, '<span class="str">$1</span>');
        return escaped;
      });

      return `<pre>${lines.join('\n')}</pre>`;
    }

    function formatMd(text) {
      if (!text) return '';
      return esc(text)
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/`([^`]+)`/g, '<code class="icode">$1</code>')
        .replace(/\n/g, '<br>');
    }
    
    function formatAnswerStructured(text) {
      if (!text) return '<p style="color:var(--muted)">ÊöÇÊó†Ëß£Êûê</p>';
      
      // Split by ### headers
      const sections = [];
      const lines = text.split('\n');
      let currentSection = { title: '', content: [] };
      
      for (const line of lines) {
        if (line.startsWith('### ')) {
          // Save previous section
          if (currentSection.title || currentSection.content.length) {
            sections.push({ ...currentSection });
          }
          currentSection = { title: line.replace('### ', '').trim(), content: [] };
        } else if (line.trim()) {
          currentSection.content.push(line);
        }
      }
      // Save last section
      if (currentSection.title || currentSection.content.length) {
        sections.push(currentSection);
      }
      
      // If no sections found, just format as simple text
      if (sections.length === 0 || (sections.length === 1 && !sections[0].title)) {
        return `<div class="answer-section"><div class="answer-section-content">${formatMdRich(text)}</div></div>`;
      }
      
      // Render sections as cards
      const iconMap = {
        'ÁÆóÊ≥ï': ['üß†', 'algo'],
        '‰ºòÂåñ': ['‚ö°', 'algo'],
        'ÂÖ≥ÈîÆ': ['üîë', 'impl'],
        'ËæπÁïå': ['‚ö†Ô∏è', 'edge'],
        'Êù°‰ª∂': ['‚ö†Ô∏è', 'edge'],
        'ÈîôËØØ': ['‚ùå', 'error'],
        'Èô∑Èò±': ['‚ùå', 'error'],
        'ÊäÄÂ∑ß': ['üí°', 'impl'],
        'ÂÆûÁé∞': ['üíª', 'impl'],
        '‰∏∫‰ªÄ‰πà': ['ü§î', 'algo'],
        'Ê®°Êùø': ['üìù', 'impl'],
        'ÈªòËÆ§': ['üìå', '']
      };
      
      function getIcon(title) {
        for (const [key, val] of Object.entries(iconMap)) {
          if (title.includes(key)) return val;
        }
        return iconMap['ÈªòËÆ§'];
      }
      
      return sections.map(sec => {
        const [icon, cls] = sec.title ? getIcon(sec.title) : ['üìå', ''];
        const content = formatMdRich(sec.content.join('\n'));
        
        if (!sec.title) {
          return `<div class="answer-section ${cls}"><div class="answer-section-content">${content}</div></div>`;
        }
        
        return `
          <div class="answer-section ${cls}">
            <div class="answer-section-title">${icon} ${esc(sec.title)}</div>
            <div class="answer-section-content">${content}</div>
          </div>
        `;
      }).join('');
    }
    
    function formatMdRich(text) {
      if (!text) return '';
      let html = esc(text);
      
      // Code blocks (```python ... ```)
      html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) => {
        return `<pre><code>${code.trim()}</code></pre>`;
      });
      
      // Inline code
      html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
      
      // Bold
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      
      // Lists
      html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
      html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
      
      // Line breaks
      html = html.replace(/\n/g, '<br>');
      
      // Clean up extra br in pre
      html = html.replace(/<pre><code>([\s\S]*?)<\/code><\/pre>/g, (_, code) => {
        return `<pre><code>${code.replace(/<br>/g, '\n')}</code></pre>`;
      });
      
      return html;
    }

    // Handle tab key in textareas
    document.addEventListener('keydown', function(e) {
      if (e.target.classList.contains('code-input') && e.key === 'Tab') {
        e.preventDefault();
        const start = e.target.selectionStart;
        const end = e.target.selectionEnd;
        e.target.value = e.target.value.substring(0, start) + '    ' + e.target.value.substring(end);
        e.target.selectionStart = e.target.selectionEnd = start + 4;
      }
    });

    // ---- PWA Install Prompt ----
    let deferredPrompt = null;
    
    try {
      const installBanner = document.getElementById('installBanner');
      const installBtn = document.getElementById('installBtn');

      // Check if already installed
      if (window.matchMedia('(display-mode: standalone)').matches) {
        console.log('Already installed as PWA');
        if (installBanner) installBanner.style.display = 'none';
      } else if (installBanner && installBtn) {
        // Listen for install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          deferredPrompt = e;
          installBanner.style.display = 'block';
          console.log('Install prompt ready');
        });

        // Handle install button click
        installBtn.addEventListener('click', async () => {
          if (!deferredPrompt) {
            alert('ËØ∑‰ΩøÁî®ÊµèËßàÂô®ËèúÂçï‰∏≠ÁöÑ"Ê∑ªÂä†Âà∞‰∏ªÂ±èÂπï"ÈÄâÈ°π');
            return;
          }
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          console.log('Install outcome:', outcome);
          deferredPrompt = null;
          installBanner.style.display = 'none';
        });

        // Hide banner if installed
        window.addEventListener('appinstalled', () => {
          installBanner.style.display = 'none';
          console.log('App installed!');
        });
      }
    } catch (e) {
      console.error('PWA install setup error:', e);
    }

    init();

    // ---- Answer Overlay Functions ----
    function showAnswerOverlay(title, content) {
      const overlay = document.getElementById('answerOverlay');
      const titleEl = document.getElementById('answerModalTitle');
      const bodyEl = document.getElementById('answerModalBody');
      
      titleEl.textContent = title;
      bodyEl.innerHTML = content;
      overlay.classList.add('show');
      
      // Prevent body scroll
      document.body.style.overflow = 'hidden';
    }
    
    function closeAnswerOverlay() {
      const overlay = document.getElementById('answerOverlay');
      overlay.classList.remove('show');
      document.body.style.overflow = '';
    }

    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('SW registered:', reg.scope))
        .catch(err => console.log('SW registration failed:', err));
    }
  </script>
  
  <!-- Answer Overlay Modal -->
  <div class="answer-overlay" id="answerOverlay" onclick="if(event.target === this) closeAnswerOverlay()">
    <div class="answer-modal">
      <div class="answer-modal-header">
        <span class="answer-modal-title" id="answerModalTitle">üí° Ëß£Êûê</span>
        <button class="answer-modal-close" onclick="closeAnswerOverlay()">‚úï</button>
      </div>
      <div class="answer-modal-body" id="answerModalBody"></div>
    </div>
  </div>
</body>
</html>
